<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>User Authority Management</title>
    <meta name="X-Auth-Token" th:if="${session != null}" th:content="${session.id}">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .user-select {
            margin-bottom: 20px;
        }
        .authority-tree {
            margin: 24px 0;
            font-size: 14px;
        }
        .tree-node {
            margin: 6px 0;
            padding-left: 24px;
        }
        .tree-node label {
            display: inline-block;
            margin-left: 8px;
            cursor: pointer;
        }
        .error {
            color: #dc3545;
            padding: 10px 20px;
            margin: 10px 0;
            border: 1px solid #dc3545;
            border-radius: 4px;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .success {
            color: #28a745;
            padding: 10px 20px;
            margin: 10px 0;
            border: 1px solid #28a745;
            border-radius: 4px;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background: #c82333;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        .message-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            pointer-events: none;
        }

        .error.show, .success.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .select-type {
            margin-bottom: 16px;
        }
        
        .select-type label {
            margin-right: 24px;
            cursor: pointer;
        }
        
        .select-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .current-target {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
            color: #666;
        }
        h1 {
            color: #333;
            font-size: 24px;
            margin: 0;
        }
        select, input[type="radio"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }
        label {
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }
        .authority-checkbox {
            cursor: pointer;
        }
        .home-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .home-btn:hover {
            background: #0056b3;
        }
        .back-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        .back-btn:hover {
            background: #5a6268;
        }
        .authority-tree-placeholder {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
            color: #6c757d;
            border: 1px dashed #dee2e6;
            margin: 20px 0;
            font-size: 14px;
        }

        /* æœªé€‰æ‹©ç›®æ ‡æ—¶ç¦ç”¨å¤é€‰æ¡†çš„æ ·å¼ */
        .authority-checkbox[disabled] {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* å›¾æ ‡æ ·å¼ - å–æ¶ˆæ–œä½“ */
        i {
            font-style: normal !important;
        }
        
        /* ç”¨æˆ·æœç´¢æ ·å¼ */
        .search-container {
            position: relative;
            width: 100%;
        }
        .search-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .search-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .search-dropdown.show {
            display: block;
        }
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        .dropdown-item.selected {
            background-color: #007bff;
            color: white;
        }
        .user-info {
            font-size: 14px;
        }
        .user-name {
            font-weight: 500;
            color: #333;
        }
        .user-identifications {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container" sec:authorize="hasRole('ADMIN')">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="/" class="home-btn">
                    <i>ğŸ </i> Home
                </a>
                <a id="back-btn" class="back-btn">
                    <i>â¬…ï¸</i> Back
                </a>
                <h1>User Authority Management</h1>
            </div>
            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>

        <div class="user-select">
            <div class="select-type">
                <label>
                    <input type="radio" name="targetType" value="user" checked 
                           id="userTypeRadio"> User
                </label>
                <label>
                    <input type="radio" name="targetType" value="group" 
                           id="groupTypeRadio"> Group
                </label>
            </div>
            <div class="select-container">
                <label for="target">Select User or Group:</label>
                <!-- ç”¨æˆ·é€‰æ‹©ï¼šæœç´¢è¾“å…¥æ¡† + ä¸‹æ‹‰åˆ—è¡¨ -->
                <div id="user-search-container" class="search-container">
                    <input type="text" 
                           id="user-search-input" 
                           class="search-input" 
                           placeholder="Search users by username or identification..."
                           autocomplete="off">
                    <div id="user-dropdown" class="search-dropdown"></div>
                </div>
                <!-- ç»„é€‰æ‹©ï¼šä¼ ç»Ÿä¸‹æ‹‰æ¡† -->
                <select id="group-select" style="display: none;"></select>
            </div>
        </div>

        <div id="authority-tree" class="authority-tree"></div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>
    </div>

    <div class="message-container">
        <div id="error-message" class="error"></div>
        <div id="success-message" class="success"></div>
    </div>

    <script th:inline="javascript">
        let baseAuthoritys = [];
        let currentAuthoritys = new Set();
        let currentTarget = null;
        let currentTargetType = 'user';
        let groups = [];
        let searchTimeout = null;
        let currentUsers = [];

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–å‡½æ•°
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                showLoading();
                
                // 1. è®¾ç½®å›é€€æŒ‰é’®
                const urlParams = new URLSearchParams(window.location.search);
                const fromPage = urlParams.get('from');
                const backBtn = document.getElementById('back-btn');
                if (fromPage === 'user-management') {
                    backBtn.href = '/user-management';
                } else if (fromPage === 'group-management') {
                    backBtn.href = '/group-management';
                } else {
                    backBtn.href = '/';
                }

                // 2. åŠ è½½åŸºç¡€æ•°æ®
                await loadBaseAuthoritys();
                await loadGroups();

                // 3. å¤„ç†ä»ç”¨æˆ·ç®¡ç†æˆ–ç»„ç®¡ç†é¡µé¢è¿›å…¥çš„æƒ…å†µ
                const type = urlParams.get('type');
                const target = urlParams.get('target');
                
                if ((type === 'user' && fromPage === 'user-management') || 
                    (type === 'group' && fromPage === 'group-management')) {
                    // ä»ç®¡ç†é¡µé¢è¿›å…¥çš„ç‰¹æ®Šå¤„ç†
                    console.log(`Entering from ${fromPage}`);
                    
                    // ç¦ç”¨é€‰æ‹©å™¨
                    document.getElementById('userTypeRadio').disabled = true;
                    document.getElementById('groupTypeRadio').disabled = true;
                    
                    // è®¾ç½®å½“å‰å€¼
                    currentTargetType = type;
                    document.getElementById(`${type}TypeRadio`).checked = true;
                    
                    // æ›´æ–°é€‰æ‹©å™¨å¹¶è®¾ç½®å€¼
                    await updateTargetSelect();
                    
                    if (currentTargetType === 'user') {
                        // å¯¹äºç”¨æˆ·ç±»å‹ï¼Œè®¾ç½®æœç´¢è¾“å…¥æ¡†çš„å€¼
                        document.getElementById('user-search-input').value = target;
                    } else {
                        // å¯¹äºç»„ç±»å‹ï¼Œè®¾ç½®ä¸‹æ‹‰é€‰æ‹©å™¨çš„å€¼
                        document.getElementById('group-select').value = target;
                    }
                    
                    // åŠ è½½ç›®æ ‡æƒé™
                    currentTarget = target;
                    await loadTargetAuthoritys();
                    renderAuthorityTree();
                } else {
                    // ä»é¦–é¡µè¿›å…¥çš„åŸæœ‰é€»è¾‘
                    console.log('Entering from home page');
                    
                    // å¯ç”¨æ‰€æœ‰æ§ä»¶
                    document.getElementById('userTypeRadio').disabled = false;
                    document.getElementById('groupTypeRadio').disabled = false;
                    
                    // ç›‘å¬ç±»å‹é€‰æ‹©å˜åŒ–
                    document.querySelectorAll('input[name="targetType"]').forEach(radio => {
                        radio.addEventListener('change', async (e) => {
                            currentTargetType = e.target.value;
                            await updateTargetSelect();
                        });
                    });
                    
                    // è®¾ç½®ç”¨æˆ·æœç´¢åŠŸèƒ½
                    setupUserSearch();
                    
                    // ç›‘å¬ç»„é€‰æ‹©å˜åŒ–
                    document.getElementById('group-select').addEventListener('change', async (e) => {
                        currentTarget = e.target.value;
                        currentAuthoritys.clear();
                        
                        if (currentTarget) {
                            await loadTargetAuthoritys();
                        }
                        
                        renderAuthorityTree();
                    });
                    
                    // åˆå§‹åŒ–é€‰æ‹©å™¨
                    await updateTargetSelect();
                }
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Load users from backend with search
        async function loadUsers(search = '') {
            try {
                console.log('Fetching users list with search:', search);
                const params = new URLSearchParams();
                if (search.trim()) {
                    params.append('search', search.trim());
                }
                params.append('limit', '20');
                
                const response = await fetch(`/api/authorities/users?${params}`, {
                    headers: {
                        [[${ _csrf.headerName }]]: [[${ _csrf.token }]]
                    }
                });
                const users = await response.json();
                console.log('Received users data:', users);
                return users;
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Failed to load users: ' + error.message);
                return [];
            }
        }

        // Load base authorities
        async function loadBaseAuthoritys() {
            showLoading();
            try {
                console.log('Loading base authorities...');
                                 const response = await fetch('/api/authorities/base', {
                    headers: {
                        [[${ _csrf.headerName }]]: [[${ _csrf.token }]]
                    }
                });
                const authorities = await response.json();
                console.log('Received base authorities:', authorities);
                baseAuthoritys = authorities.filter(p => p.enabled !== false);
                console.log('Filtered active authorities:', baseAuthoritys);
            } catch (error) {
                console.error('Error loading base authorities:', error);
                showError('Failed to load authorities: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Load users from backend
        async function loadGroups() {
            try {
                                 const response = await fetch('/api/authorities/groups', {
                    headers: {
                        [[${ _csrf.headerName }]]: [[${ _csrf.token }]]
                    }
                });
                groups = await response.json();
            } catch (error) {
                console.error('Error loading groups:', error);
                showError('Failed to load groups: ' + error.message);
            }
        }

        // æ›´æ–°é€‰æ‹©å™¨é€‰é¡¹
        async function updateTargetSelect() {
            if (currentTargetType === 'user') {
                // æ˜¾ç¤ºç”¨æˆ·æœç´¢å®¹å™¨ï¼Œéšè—ç»„é€‰æ‹©å™¨
                document.getElementById('user-search-container').style.display = 'block';
                document.getElementById('group-select').style.display = 'none';
                
                // æ¸…ç©ºæœç´¢è¾“å…¥æ¡†
                document.getElementById('user-search-input').value = '';
                document.getElementById('user-dropdown').classList.remove('show');
            } else {
                // æ˜¾ç¤ºç»„é€‰æ‹©å™¨ï¼Œéšè—ç”¨æˆ·æœç´¢å®¹å™¨
                document.getElementById('user-search-container').style.display = 'none';
                document.getElementById('group-select').style.display = 'block';
                
                // å¡«å……ç»„é€‰æ‹©å™¨
                const groupSelect = document.getElementById('group-select');
                groupSelect.innerHTML = '<option value="">Select Group...</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    groupSelect.appendChild(option);
                });
            }
            
            // æ¸…ç©ºå½“å‰æƒé™
            currentTarget = null;
            currentAuthoritys.clear();
            renderAuthorityTree();
        }

        // åŠ è½½ç›®æ ‡çš„æƒé™
        async function loadTargetAuthoritys() {
            showLoading();
            try {
                let response;
                if (currentTargetType === 'user') {
                    response = await fetch(`/api/authorities/user/${currentTarget}`);
                } else {
                    response = await fetch(`/api/authorities/group/${currentTarget}`);
                }
                const authorities = await response.json();
                currentAuthoritys = new Set(authorities);
            } catch (error) {
                console.error('Error loading authorities:', error);
                showError('Failed to load authorities: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Build and render the authority tree
        function renderAuthorityTree() {
            const treeContainer = document.getElementById('authority-tree');
            
            if (!currentTarget) {
                // å½“æ²¡æœ‰é€‰æ‹©ç›®æ ‡æ—¶æ˜¾ç¤ºæç¤ºä¿¡æ¯
                treeContainer.innerHTML = `
                    <div class="authority-tree-placeholder">
                        <i>â„¹ï¸</i> Please select a ${currentTargetType} to manage authorities
                    </div>
                `;
                return;
            }

            const tree = buildAuthorityTree(baseAuthoritys);
            const treeHtml = renderTreeNode(tree);
            treeContainer.innerHTML = treeHtml;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.authority-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleAuthorityChange);
            });

            // åˆå§‹åŒ–çˆ¶èŠ‚ç‚¹çŠ¶æ€
            updateParentNodeStates();
        }

        // Build tree structure from flat authorities
        function buildAuthorityTree(authorities) {
            const tree = {};
            authorities.forEach(authority => {
                // å¦‚æœæƒé™è¢«æ˜ç¡®ç¦ç”¨ï¼ˆenabled = falseï¼‰ï¼Œåˆ™è·³è¿‡
                if (authority.enabled === false) {
                    return;
                }

                const parts = authority.authority_id.split('_');
                let current = tree;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (i === parts.length - 1) {
                        current[part] = {};  // å¶å­èŠ‚ç‚¹
                    } else {
                        current[part] = current[part] || {};
                        current = current[part];
                    }
                }
            });
            return tree;
        }

        // Render tree node recursively
        function renderTreeNode(node, path = []) {
            let html = '<ul>';
            for (const [key, value] of Object.entries(node)) {
                const currentPath = [...path, key];
                const fullAuthority = currentPath.join('_');
                const isLeaf = Object.keys(value).length === 0;
                
                html += `<li class="tree-node">`;
                html += `<input type="checkbox" class="authority-checkbox" 
                               id="${fullAuthority}" 
                               data-authority="${fullAuthority}"
                               data-is-parent="${!isLeaf}"
                               ${currentAuthoritys.has(fullAuthority) ? 'checked' : ''}
                               ${!currentTarget ? 'disabled' : ''}>`;
                html += `<label for="${fullAuthority}" ${!currentTarget ? 'style="cursor: default;"' : ''}>${key}</label>`;
                
                if (!isLeaf) {
                    html += renderTreeNode(value, currentPath);
                }
                html += '</li>';
            }
            html += '</ul>';
            return html;
        }

        // Handle authority checkbox changes
        async function handleAuthorityChange(event) {
            if (!currentTarget) return;

            const checkbox = event.target;
            const authority = checkbox.dataset.authority;
            const isParent = checkbox.dataset.isParent === 'true';
            const isChecked = checkbox.checked;
            
            if (isParent) {
                // å¦‚æœæ˜¯ä¸­é—´çŠ¶æ€ï¼Œç‚¹å‡»ååº”è¯¥å˜ä¸ºæœªé€‰ä¸­çŠ¶æ€
                if (checkbox.indeterminate) {
                    checkbox.indeterminate = false;
                    checkbox.checked = false;
                }
                
                const childAuthoritys = getChildAuthoritys(authority);
                
                showLoading();
                try {
                    const endpoint = currentTargetType === 'user' ? 
                        '/api/authorities/batch-update' : 
                        '/api/authorities/group/batch-update';
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [[${ _csrf.headerName }]]: [[${ _csrf.token }]]
                        },
                        body: JSON.stringify(currentTargetType === 'user' ? {
                            username: currentTarget,
                            authorities: childAuthoritys,
                            granted: isChecked
                        } : {
                            groupId: currentTarget,
                            authorities: childAuthoritys,
                            granted: isChecked
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update authorities');
                    }

                    // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                    childAuthoritys.forEach(perm => {
                        const childCheckbox = document.querySelector(`input[data-authority="${perm}"]`);
                        if (childCheckbox) {
                            childCheckbox.checked = isChecked;
                        }
                        if (isChecked) {
                            currentAuthoritys.add(perm);
                        } else {
                            currentAuthoritys.delete(perm);
                        }
                    });

                    showSuccess(`Authoritys ${isChecked ? 'granted' : 'revoked'} successfully`);
                } catch (error) {
                    showError('Failed to update authorities: ' + error.message);
                    checkbox.checked = !isChecked;
                } finally {
                    hideLoading();
                    updateParentNodeStates(); // æ›´æ–°æ‰€æœ‰çˆ¶èŠ‚ç‚¹çŠ¶æ€
                }
            } else {
                // å¶å­èŠ‚ç‚¹å¤„ç†é€»è¾‘
                showLoading();
                try {
                    const endpoint = currentTargetType === 'user' ? 
                        '/api/authorities/update' : 
                        '/api/authorities/group/update';
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [[${ _csrf.headerName }]]: [[${ _csrf.token }]]
                        },
                        body: JSON.stringify(currentTargetType === 'user' ? {
                            username: currentTarget,
                            authority: authority,
                            granted: isChecked
                        } : {
                            groupId: currentTarget,
                            authority: authority,
                            granted: isChecked
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update authority');
                    }

                    if (isChecked) {
                        currentAuthoritys.add(authority);
                    } else {
                        currentAuthoritys.delete(authority);
                    }

                    showSuccess(`Authority ${isChecked ? 'granted' : 'revoked'} successfully`);
                } catch (error) {
                    showError('Failed to update authority: ' + error.message);
                    checkbox.checked = !isChecked; // Revert checkbox state
                } finally {
                    hideLoading();
                    updateParentNodeStates(); // æ›´æ–°æ‰€æœ‰çˆ¶èŠ‚ç‚¹çŠ¶æ€
                }
            }
        }

        // æ·»åŠ è·å–å­èŠ‚ç‚¹æƒé™çš„è¾…åŠ©å‡½æ•°
        function getChildAuthoritys(parentAuthority) {
            const authorities = [];
            const parentParts = parentAuthority.split('_');
            
            // é€’å½’æŸ¥æ‰¾æ‰€æœ‰å¶å­èŠ‚ç‚¹æƒé™
            function findLeafAuthoritys(node, currentPath) {
                for (const [key, value] of Object.entries(node)) {
                    const newPath = [...currentPath, key];
                    if (Object.keys(value).length === 0) {
                        authorities.push(newPath.join('_'));
                    } else {
                        findLeafAuthoritys(value, newPath);
                    }
                }
            }
            
            // ä»çˆ¶èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾
            let currentNode = buildAuthorityTree(baseAuthoritys);
            let path = [];
            for (const part of parentParts) {
                path.push(part);
                currentNode = findNodeByPath(currentNode, part);
            }
            
            findLeafAuthoritys(currentNode, path);
            return authorities;
        }

        // æ·»åŠ æŸ¥æ‰¾èŠ‚ç‚¹çš„è¾…åŠ©å‡½æ•°
        function findNodeByPath(node, pathPart) {
            // å¦‚æœè¾“å…¥æ˜¯æ•°ç»„ï¼Œéœ€è¦å…ˆå°†å…¶è½¬æ¢ä¸ºæ ‘å½¢ç»“æ„
            if (Array.isArray(node)) {
                node = buildAuthorityTree(node);
            }
            
            for (const [key, value] of Object.entries(node)) {
                if (key === pathPart) {
                    return value;
                }
            }
            return {};
        }

        // æ·»åŠ æ›´æ–°çˆ¶èŠ‚ç‚¹çŠ¶æ€çš„å‡½æ•°
        function updateParentNodeStates() {
            // ä»ä¸‹å¾€ä¸Šéå†ï¼Œæ›´æ–°çˆ¶èŠ‚ç‚¹çŠ¶æ€
            const parents = new Set();
            document.querySelectorAll('.authority-checkbox[data-is-parent="true"]').forEach(parentCheckbox => {
                parents.add(parentCheckbox.dataset.authority);
            });

            parents.forEach(parentAuthority => {
                const parentCheckbox = document.querySelector(`input[data-authority="${parentAuthority}"]`);
                const childCheckboxes = getChildCheckboxes(parentAuthority);
                
                const checkedCount = childCheckboxes.filter(cb => cb.checked).length;
                
                if (checkedCount === 0) {
                    // æ²¡æœ‰å­èŠ‚ç‚¹é€‰ä¸­
                    parentCheckbox.checked = false;
                    parentCheckbox.indeterminate = false;
                } else if (checkedCount === childCheckboxes.length) {
                    // æ‰€æœ‰å­èŠ‚ç‚¹éƒ½é€‰ä¸­
                    parentCheckbox.checked = true;
                    parentCheckbox.indeterminate = false;
                } else {
                    // éƒ¨åˆ†å­èŠ‚ç‚¹é€‰ä¸­
                    parentCheckbox.checked = false;
                    parentCheckbox.indeterminate = true;
                }
            });
        }

        // è·å–å­èŠ‚ç‚¹å¤é€‰æ¡†çš„è¾…åŠ©å‡½æ•°
        function getChildCheckboxes(parentAuthority) {
            const childAuthoritys = getChildAuthoritys(parentAuthority);
            return childAuthoritys.map(perm => 
                document.querySelector(`input[data-authority="${perm}"]`)
            ).filter(Boolean);
        }
        
        // è®¾ç½®ç”¨æˆ·æœç´¢åŠŸèƒ½
        function setupUserSearch() {
            const searchInput = document.getElementById('user-search-input');
            const dropdown = document.getElementById('user-dropdown');
            
            // æœç´¢è¾“å…¥äº‹ä»¶
            searchInput.addEventListener('input', function() {
                const searchValue = this.value.trim();
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ300msåæ‰§è¡Œæœç´¢
                searchTimeout = setTimeout(async () => {
                    if (searchValue.length >= 1) {
                        await searchUsers(searchValue);
                    } else {
                        dropdown.classList.remove('show');
                    }
                }, 300);
            });
            
            // ç‚¹å‡»è¾“å…¥æ¡†æ—¶ï¼Œå¦‚æœæœ‰æœç´¢ç»“æœåˆ™æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
            searchInput.addEventListener('focus', function() {
                if (currentUsers.length > 0) {
                    dropdown.classList.add('show');
                }
            });
            
            // ç‚¹å‡»å¤–éƒ¨éšè—ä¸‹æ‹‰åˆ—è¡¨
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }
        
        // æœç´¢ç”¨æˆ·
        async function searchUsers(search) {
            try {
                currentUsers = await loadUsers(search);
                displayUserDropdown(currentUsers);
            } catch (error) {
                console.error('Error searching users:', error);
                showError('Failed to search users');
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¸‹æ‹‰åˆ—è¡¨
        function displayUserDropdown(users) {
            const dropdown = document.getElementById('user-dropdown');
            
            if (users.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item">No users found</div>';
            } else {
                dropdown.innerHTML = users.map(user => {
                    const displayName = user.username;
                    const identifications = user.identifications ? user.identifications : '';
                    
                    return `
                        <div class="dropdown-item" data-username="${user.username}">
                            <div class="user-info">
                                <div class="user-name">${displayName}</div>
                                ${identifications ? `<div class="user-identifications">${identifications}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                dropdown.querySelectorAll('.dropdown-item[data-username]').forEach(item => {
                    item.addEventListener('click', function() {
                        const username = this.dataset.username;
                        selectUser(username);
                    });
                });
            }
            
            dropdown.classList.add('show');
        }
        
        // é€‰æ‹©ç”¨æˆ·
        async function selectUser(username) {
            const searchInput = document.getElementById('user-search-input');
            const dropdown = document.getElementById('user-dropdown');
            
            // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
            const selectedUser = currentUsers.find(u => u.username === username);
            if (selectedUser) {
                searchInput.value = selectedUser.username;
                if (selectedUser.identifications) {
                    searchInput.title = `${selectedUser.username} - ${selectedUser.identifications}`;
                }
            }
            
            // éšè—ä¸‹æ‹‰åˆ—è¡¨
            dropdown.classList.remove('show');
            
            // è®¾ç½®å½“å‰ç›®æ ‡å¹¶åŠ è½½æƒé™
            currentTarget = username;
            currentAuthoritys.clear();
            
            if (currentTarget) {
                await loadTargetAuthoritys();
            }
            
            renderAuthorityTree();
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            errorDiv.textContent = message;
            successDiv.classList.remove('show');
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 3000);
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            errorDiv.classList.remove('show');
            successDiv.classList.add('show');
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html> 