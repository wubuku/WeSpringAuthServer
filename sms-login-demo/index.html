<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMSç™»å½•æ¼”ç¤º - WeSpring Auth Server</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 450px;
            width: 90%;
            position: relative;
            transition: all 0.3s ease;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        /* æ ‡é¢˜æ ·å¼ */
        .title {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .title h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .title p {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ */
        .login-container {
            display: none;
        }

        .login-container.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .phone-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .phone-input-group input {
            flex: 1;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: none;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            min-width: 120px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-full {
            width: 100%;
            margin-top: 10px;
        }

        /* ä¸šåŠ¡ç•Œé¢æ ·å¼ */
        .business-container {
            display: none;
        }

        .business-container.active {
            display: block;
        }

        .user-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .user-info h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .user-info p {
            opacity: 0.9;
            font-size: 14px;
        }

        .business-actions {
            display: grid;
            gap: 15px;
        }

        .action-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .action-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .action-card h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .action-card p {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 15px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #cce7f0;
            color: #055160;
            border: 1px solid #b6d4fe;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å€’è®¡æ—¶æ ·å¼ */
        .countdown {
            color: #667eea;
            font-weight: 600;
        }

        /* Tokenä¿¡æ¯æ˜¾ç¤º */
        .token-info {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 12px;
            color: #004085;
        }

        .token-info h5 {
            margin-bottom: 10px;
            color: #0056b3;
        }

        .token-info .token-row {
            margin-bottom: 8px;
            word-break: break-all;
        }

        .token-info .token-row strong {
            display: inline-block;
            width: 120px;
            color: #495057;
        }

        .token-refresh-section {
            margin: 15px 0;
            text-align: center;
        }

        .refresh-process {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .refresh-process h6 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }

        .process-log {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #6c757d;
            font-weight: normal;
        }

        .log-info {
            color: #007bff;
        }

        .log-success {
            color: #28a745;
            font-weight: bold;
        }

        .log-error {
            color: #dc3545;
            font-weight: bold;
        }

        .log-warning {
            color: #ffc107;
        }

        /* å“åº”å¼è®¾è®¡ - å…¨é¢ç§»åŠ¨ç«¯ä¼˜åŒ– */
        
        /* å¹³æ¿è®¾å¤‡ */
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                margin: 10px;
                padding: 30px 20px;
            }
            
            .business-actions {
                grid-template-columns: 1fr;
            }
            
            .action-card {
                padding: 15px;
            }
        }
        
        /* ç§»åŠ¨è®¾å¤‡ */
        @media (max-width: 480px) {
            body {
                padding: 0;
                min-height: 100vh;
                align-items: flex-start;
            }
            
            .container {
                max-width: 100%;
                margin: 5px;
                padding: 20px 15px;
                min-height: calc(100vh - 10px);
                border-radius: 12px;
            }

            .container:hover {
                transform: none;
            }

            /* æ ‡é¢˜ä¼˜åŒ– */
            .title {
                margin-bottom: 25px;
            }

            .title h1 {
                font-size: 22px;
                margin-bottom: 6px;
            }

            .title p {
                font-size: 13px;
            }

            /* è¾“å…¥ç»„ä¼˜åŒ– */
            .input-group {
                margin-bottom: 18px;
            }

            .input-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            .input-group input {
                padding: 16px 14px;
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                border-radius: 8px;
            }

            /* æ‰‹æœºå·è¾“å…¥ç»„ä¼˜åŒ– */
            .phone-input-group {
                flex-direction: column;
                gap: 12px;
            }

            .phone-input-group .btn-secondary {
                width: 100%;
                padding: 16px 20px;
                font-size: 15px;
                min-height: 48px; /* iOSå»ºè®®çš„æœ€å°è§¦æ‘¸ç›®æ ‡ */
            }

            /* æŒ‰é’®ä¼˜åŒ– */
            .btn {
                padding: 16px 20px;
                font-size: 15px;
                border-radius: 8px;
                min-height: 48px;
                touch-action: manipulation; /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
            }

            .btn-full {
                margin-top: 8px;
            }

            /* ç™»å‡ºæŒ‰é’®ä¼˜åŒ– */
            .logout-btn {
                top: 15px;
                right: 15px;
                padding: 8px 12px;
                font-size: 13px;
            }

            /* ä¸šåŠ¡ç•Œé¢ä¼˜åŒ– */
            .user-info {
                padding: 18px;
                margin-bottom: 20px;
                border-radius: 10px;
            }

            .user-info h3 {
                font-size: 18px;
                margin-bottom: 8px;
            }

            .user-info p {
                font-size: 13px;
                line-height: 1.4;
            }

            /* ä¸šåŠ¡å¡ç‰‡ä¼˜åŒ– */
            .business-actions {
                gap: 12px;
            }

            .action-card {
                padding: 16px;
                border-radius: 10px;
            }

            .action-card h4 {
                font-size: 15px;
                margin-bottom: 6px;
            }

            .action-card p {
                font-size: 13px;
                margin-bottom: 10px;
                line-height: 1.3;
            }

            .action-card .btn {
                padding: 10px 16px;
                font-size: 13px;
                min-height: auto;
            }

            /* Tokenä¿¡æ¯åŒºåŸŸä¼˜åŒ– */
            .token-info {
                padding: 12px;
                margin: 15px 0;
                font-size: 11px;
                border-radius: 6px;
            }

            .token-info h5 {
                font-size: 13px;
                margin-bottom: 8px;
            }

            .token-info .token-row {
                margin-bottom: 6px;
                display: flex;
                flex-direction: column;
                gap: 2px;
            }

            .token-info .token-row strong {
                width: auto;
                display: block;
                font-size: 11px;
                color: #666;
            }

            .token-info .token-row span {
                font-size: 10px;
                word-break: break-all;
                color: #333;
            }

            /* Tokenåˆ·æ–°æŒ‰é’®ä¼˜åŒ– */
            .token-refresh-section {
                margin: 12px 0;
            }

            .token-refresh-section .btn {
                width: 100%;
                padding: 12px 16px;
                font-size: 13px;
            }

            /* åˆ·æ–°è¿‡ç¨‹æ—¥å¿—ä¼˜åŒ– */
            .refresh-process {
                padding: 12px;
                margin-top: 12px;
                border-radius: 6px;
            }

            .refresh-process h6 {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .process-log {
                font-size: 10px;
                line-height: 1.3;
                max-height: 150px;
                padding: 8px;
                border-radius: 3px;
            }

            .log-entry {
                margin: 1px 0;
                padding: 1px 0;
            }

                         /* çŠ¶æ€æ¶ˆæ¯ä¼˜åŒ– */
             .status {
                 font-size: 13px;
                 padding: 10px 12px;
                 border-radius: 6px;
                 margin-top: 10px;
             }

             /* åŠ è½½åŠ¨ç”»ç§»åŠ¨ç«¯ä¼˜åŒ– */
             .loading {
                 width: 16px;
                 height: 16px;
                 border-width: 2px;
                 margin-right: 6px;
             }
        }

        /* è¶…å°å±å¹•è®¾å¤‡ */
        @media (max-width: 360px) {
            .container {
                margin: 2px;
                padding: 15px 10px;
            }

            .title h1 {
                font-size: 20px;
            }

            .input-group input {
                padding: 14px 12px;
            }

            .btn {
                padding: 14px 16px;
                font-size: 14px;
            }

            .token-info {
                padding: 10px;
                font-size: 10px;
            }

            .process-log {
                font-size: 9px;
                max-height: 120px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover:not(:disabled) {
                transform: none;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            }

            .action-card:hover {
                transform: none;
                border-color: #667eea;
                background: #f0f4ff;
            }

            .container:hover {
                transform: none;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container fade-in">
        <!-- ç™»å‡ºæŒ‰é’® -->
        <button class="logout-btn" id="logoutBtn" style="display: none;" onclick="logout()">ç™»å‡º</button>
        
        <!-- æ ‡é¢˜ -->
        <div class="title">
            <h1>ğŸ” SMSç™»å½•æ¼”ç¤º</h1>
            <p>åŸºäºWeSpring Auth Serverçš„çŸ­ä¿¡éªŒè¯ç ç™»å½•</p>
        </div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div class="login-container active" id="loginContainer">
            <div class="input-group">
                <label for="phoneNumber">æ‰‹æœºå·ç </label>
                <div class="phone-input-group">
                    <input type="tel" id="phoneNumber" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " maxlength="11">
                    <button class="btn btn-secondary" id="sendCodeBtn" onclick="sendSmsCode()">
                        <span id="sendCodeText">å‘é€éªŒè¯ç </span>
                    </button>
                </div>
            </div>

            <div class="input-group">
                <label for="verificationCode">éªŒè¯ç </label>
                <input type="text" id="verificationCode" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6">
            </div>

            <button class="btn btn-primary btn-full" id="loginBtn" onclick="performLogin()">
                <span id="loginText">ç«‹å³ç™»å½•</span>
            </button>

            <div id="loginStatus" class="status" style="display: none;"></div>
        </div>

        <!-- ä¸šåŠ¡ç•Œé¢ -->
        <div class="business-container" id="businessContainer">
            <div class="user-info">
                <h3>ğŸ‘‹ æ¬¢è¿å›æ¥ï¼</h3>
                <p id="userWelcome">æ‚¨å·²æˆåŠŸç™»å½•ç³»ç»Ÿ</p>
            </div>

            <div class="business-actions">
                <div class="action-card" onclick="viewProfile()">
                    <h4>ğŸ‘¤ æŸ¥çœ‹ä¸ªäººèµ„æ–™</h4>
                    <p>æŸ¥çœ‹å’Œç¼–è¾‘æ‚¨çš„ä¸ªäººä¿¡æ¯</p>
                    <button class="btn btn-primary">æŸ¥çœ‹è¯¦æƒ…</button>
                </div>

                <div class="action-card" onclick="viewOrders()">
                    <h4>ğŸ“‹ æˆ‘çš„è®¢å•</h4>
                    <p>æŸ¥çœ‹æ‚¨çš„å†å²è®¢å•å’Œå½“å‰çŠ¶æ€</p>
                    <button class="btn btn-primary">æŸ¥çœ‹è®¢å•</button>
                </div>

                <div class="action-card" onclick="viewSettings()">
                    <h4>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h4>
                    <p>ä¸ªæ€§åŒ–è®¾ç½®å’Œåå¥½é…ç½®</p>
                    <button class="btn btn-primary">è¿›å…¥è®¾ç½®</button>
                </div>

                <div class="action-card" onclick="viewApiTest()">
                    <h4>ğŸ”§ APIæµ‹è¯•</h4>
                    <p>æµ‹è¯•å—ä¿æŠ¤çš„APIæ¥å£</p>
                    <button class="btn btn-primary">æµ‹è¯•API</button>
                </div>
            </div>

            <!-- Tokenä¿¡æ¯æ˜¾ç¤º -->
            <div class="token-info">
                <h5>ğŸ”‘ å½“å‰Tokenä¿¡æ¯</h5>
                <div class="token-row">
                    <strong>Access Token:</strong>
                    <span id="accessTokenDisplay">æœªè·å–</span>
                </div>
                <div class="token-row">
                    <strong>è¿‡æœŸæ—¶é—´:</strong>
                    <span id="tokenExpiryDisplay">æœªçŸ¥</span>
                </div>
                <div class="token-row">
                    <strong>è‡ªåŠ¨åˆ·æ–°:</strong>
                    <span id="autoRefreshStatus">å·²å¯ç”¨</span>
                </div>
                
                <!-- æ‰‹åŠ¨åˆ·æ–°TokenæŒ‰é’® -->
                <div class="token-refresh-section">
                    <button class="btn btn-secondary" id="manualRefreshBtn" onclick="manualRefreshToken()">
                        <span id="refreshBtnText">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°Token</span>
                    </button>
                </div>
                
                <!-- Tokenåˆ·æ–°è¿‡ç¨‹æ˜¾ç¤º -->
                <div class="refresh-process" id="refreshProcess" style="display: none;">
                    <h6>ğŸ”„ Tokenåˆ·æ–°è¿‡ç¨‹</h6>
                    <div class="process-log" id="processLog">
                        <!-- åŠ¨æ€å†…å®¹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®å¸¸é‡
        const CONFIG = {
            AUTH_SERVER_BASE_URL: 'http://localhost:9000',
            CLIENT_ID: 'ffv-client',
            CLIENT_SECRET: 'secret',
            STORAGE_KEYS: {
                ACCESS_TOKEN: 'sms_access_token',
                REFRESH_TOKEN: 'sms_refresh_token',
                TOKEN_EXPIRY: 'sms_token_expiry',
                USER_INFO: 'sms_user_info'
            }
        };

        // Tokenç®¡ç†å™¨
        class TokenManager {
            constructor() {
                this.autoRefreshTimer = null;
                this.setupAutoRefresh();
            }

            // å­˜å‚¨token
            storeTokens(accessToken, refreshToken, expiresIn) {
                const now = new Date().getTime();
                const expiryTime = now + (expiresIn * 1000);
                
                localStorage.setItem(CONFIG.STORAGE_KEYS.ACCESS_TOKEN, accessToken);
                localStorage.setItem(CONFIG.STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
                localStorage.setItem(CONFIG.STORAGE_KEYS.TOKEN_EXPIRY, expiryTime.toString());
                
                this.setupAutoRefresh();
                this.updateTokenDisplay();
                
                console.log('Tokens stored successfully', {
                    expiresIn: expiresIn,
                    expiryTime: new Date(expiryTime)
                });
            }

            // è·å–access token
            getAccessToken() {
                return localStorage.getItem(CONFIG.STORAGE_KEYS.ACCESS_TOKEN);
            }

            // è·å–refresh token
            getRefreshToken() {
                return localStorage.getItem(CONFIG.STORAGE_KEYS.REFRESH_TOKEN);
            }

            // æ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
            isTokenValid() {
                const token = this.getAccessToken();
                const expiry = localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN_EXPIRY);
                
                if (!token || !expiry) {
                    return false;
                }

                const now = new Date().getTime();
                const expiryTime = parseInt(expiry);
                
                // æå‰5åˆ†é’Ÿè®¤ä¸ºtokenå°†è¦è¿‡æœŸ
                return now < (expiryTime - 5 * 60 * 1000);
            }

            // æ¸…é™¤token
            clearTokens() {
                localStorage.removeItem(CONFIG.STORAGE_KEYS.ACCESS_TOKEN);
                localStorage.removeItem(CONFIG.STORAGE_KEYS.REFRESH_TOKEN);
                localStorage.removeItem(CONFIG.STORAGE_KEYS.TOKEN_EXPIRY);
                localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_INFO);
                
                if (this.autoRefreshTimer) {
                    clearTimeout(this.autoRefreshTimer);
                }
                
                this.updateTokenDisplay();
            }

            // åˆ·æ–°token
            async refreshToken() {
                const refreshToken = this.getRefreshToken();
                if (!refreshToken) {
                    throw new Error('No refresh token available');
                }

                try {
                    const response = await fetch(`${CONFIG.AUTH_SERVER_BASE_URL}/sms/refresh-token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'refresh_token',
                            refresh_token: refreshToken,
                            client_id: CONFIG.CLIENT_ID,
                            client_secret: CONFIG.CLIENT_SECRET
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error_description || 'Token refresh failed');
                    }

                    const data = await response.json();
                    this.storeTokens(data.access_token, data.refresh_token, data.expires_in);
                    
                    console.log('Token refreshed successfully');
                    return data.access_token;
                } catch (error) {
                    console.error('Token refresh failed:', error);
                    this.clearTokens();
                    throw error;
                }
            }

            // æ‰‹åŠ¨åˆ·æ–°tokenï¼ˆå¸¦è¯¦ç»†è¿‡ç¨‹æ˜¾ç¤ºï¼‰
            async refreshTokenWithProcess() {
                return new Promise(async (resolve, reject) => {
                    const logContainer = document.getElementById('processLog');
                    const refreshProcess = document.getElementById('refreshProcess');
                    
                    // æ¸…ç©ºæ—¥å¿—å¹¶æ˜¾ç¤ºå®¹å™¨
                    logContainer.innerHTML = '';
                    refreshProcess.style.display = 'block';
                    refreshProcess.scrollIntoView({ behavior: 'smooth' });

                    const addLog = (message, type = 'info') => {
                        const timestamp = new Date().toLocaleTimeString('zh-CN');
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="log-${type}">${message}</span>`;
                        logContainer.appendChild(logEntry);
                        logContainer.scrollTop = logContainer.scrollHeight;
                    };

                    try {
                        addLog('ğŸ”„ å¼€å§‹æ‰‹åŠ¨åˆ·æ–°Tokenè¿‡ç¨‹...', 'info');
                        
                        // æ£€æŸ¥refresh token
                        const refreshToken = this.getRefreshToken();
                        if (!refreshToken) {
                            addLog('âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°refresh token', 'error');
                            reject(new Error('No refresh token available'));
                            return;
                        }
                        
                        addLog(`âœ… æ‰¾åˆ°refresh token: ${refreshToken.substring(0, 20)}...`, 'info');
                        addLog('ğŸ“¤ æ­£åœ¨å‘é€åˆ·æ–°è¯·æ±‚åˆ°è®¤è¯æœåŠ¡å™¨...', 'info');

                        // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿä»¥ä¾¿è§‚å¯Ÿè¿‡ç¨‹
                        await new Promise(resolve => setTimeout(resolve, 500));

                        const response = await fetch(`${CONFIG.AUTH_SERVER_BASE_URL}/sms/refresh-token`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                grant_type: 'refresh_token',
                                refresh_token: refreshToken,
                                client_id: CONFIG.CLIENT_ID,
                                client_secret: CONFIG.CLIENT_SECRET
                            })
                        });

                        addLog(`ğŸ“¥ æ”¶åˆ°æœåŠ¡å™¨å“åº”ï¼ŒçŠ¶æ€ç : ${response.status}`, 'info');

                        if (!response.ok) {
                            const errorData = await response.json();
                            const errorMsg = errorData.error_description || 'Token refresh failed';
                            addLog(`âŒ åˆ·æ–°å¤±è´¥: ${errorMsg}`, 'error');
                            reject(new Error(errorMsg));
                            return;
                        }

                        const data = await response.json();
                        addLog('âœ… æˆåŠŸè§£æå“åº”æ•°æ®', 'success');
                        addLog(`ğŸ”‘ æ–°çš„Access Token: ${data.access_token.substring(0, 30)}...`, 'info');
                        addLog(`ğŸ”‘ æ–°çš„Refresh Token: ${data.refresh_token.substring(0, 30)}...`, 'info');
                        addLog(`â° Tokenæœ‰æ•ˆæœŸ: ${data.expires_in}ç§’`, 'info');

                        // å­˜å‚¨æ–°çš„tokens
                        this.storeTokens(data.access_token, data.refresh_token, data.expires_in);
                        addLog('ğŸ’¾ æ–°Tokenå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'success');
                        
                        // æ›´æ–°æ˜¾ç¤º
                        this.updateTokenDisplay();
                        addLog('ğŸ‰ Tokenåˆ·æ–°å®Œæˆï¼é¡µé¢ä¿¡æ¯å·²æ›´æ–°', 'success');
                        
                        console.log('Manual token refresh completed successfully');
                        resolve(data.access_token);

                    } catch (error) {
                        addLog(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                        console.error('Manual token refresh failed:', error);
                        this.clearTokens();
                        reject(error);
                    }
                });
            }

            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            setupAutoRefresh() {
                if (this.autoRefreshTimer) {
                    clearTimeout(this.autoRefreshTimer);
                }

                const expiry = localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN_EXPIRY);
                if (!expiry) return;

                const now = new Date().getTime();
                const expiryTime = parseInt(expiry);
                
                // æå‰10åˆ†é’Ÿåˆ·æ–°token
                const refreshTime = expiryTime - now - (10 * 60 * 1000);
                
                if (refreshTime > 0) {
                    this.autoRefreshTimer = setTimeout(async () => {
                        try {
                            await this.refreshToken();
                            showStatus('Tokenå·²è‡ªåŠ¨åˆ·æ–°', 'success');
                        } catch (error) {
                            showStatus('Tokenè‡ªåŠ¨åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                            showLoginForm();
                        }
                    }, refreshTime);
                    
                    console.log(`Auto refresh scheduled in ${Math.round(refreshTime / 1000 / 60)} minutes`);
                }
            }

            // æ›´æ–°tokenæ˜¾ç¤º
            updateTokenDisplay() {
                const accessToken = this.getAccessToken();
                const expiry = localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN_EXPIRY);
                
                const accessTokenDisplay = document.getElementById('accessTokenDisplay');
                const tokenExpiryDisplay = document.getElementById('tokenExpiryDisplay');
                
                if (accessToken && accessTokenDisplay) {
                    accessTokenDisplay.textContent = accessToken.substring(0, 20) + '...';
                }
                
                if (expiry && tokenExpiryDisplay) {
                    const expiryDate = new Date(parseInt(expiry));
                    tokenExpiryDisplay.textContent = expiryDate.toLocaleString('zh-CN');
                }
            }
        }

        // SMSç™»å½•ç®¡ç†å™¨
        class SmsLoginManager {
            constructor(tokenManager) {
                this.tokenManager = tokenManager;
                this.sendCodeCooldown = 0;
                this.cooldownTimer = null;
            }

            // å‘é€éªŒè¯ç 
            async sendVerificationCode(phoneNumber) {
                if (this.sendCodeCooldown > 0) {
                    showStatus(`è¯·ç­‰å¾… ${this.sendCodeCooldown} ç§’åé‡è¯•`, 'error');
                    return false;
                }

                if (!this.validatePhoneNumber(phoneNumber)) {
                    showStatus('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ', 'error');
                    return false;
                }

                try {
                    showLoading('sendCodeBtn', 'å‘é€ä¸­...');

                    const response = await fetch(`${CONFIG.AUTH_SERVER_BASE_URL}/sms/send-code`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            phoneNumber: phoneNumber
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showStatus('éªŒè¯ç å‘é€æˆåŠŸï¼Œè¯·æŸ¥æ”¶çŸ­ä¿¡', 'success');
                        this.startCooldown();
                        return true;
                    } else {
                        showStatus(`å‘é€å¤±è´¥: ${data.message}`, 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('Send SMS error:', error);
                    showStatus('å‘é€éªŒè¯ç æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    return false;
                } finally {
                    hideLoading('sendCodeBtn', 'å‘é€éªŒè¯ç ');
                }
            }

            // æ‰§è¡Œç™»å½•
            async performLogin(phoneNumber, verificationCode) {
                if (!this.validatePhoneNumber(phoneNumber)) {
                    showStatus('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ', 'error');
                    return false;
                }

                if (!this.validateVerificationCode(verificationCode)) {
                    showStatus('è¯·è¾“å…¥6ä½éªŒè¯ç ', 'error');
                    return false;
                }

                try {
                    showLoading('loginBtn', 'ç™»å½•ä¸­...');

                    const response = await fetch(`${CONFIG.AUTH_SERVER_BASE_URL}/sms/auth?` + new URLSearchParams({
                        mobileNumber: phoneNumber,
                        verificationCode: verificationCode,
                        clientId: CONFIG.CLIENT_ID
                    }), {
                        method: 'GET'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // å­˜å‚¨token
                        this.tokenManager.storeTokens(data.access_token, data.refresh_token, data.expires_in);
                        
                        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
                        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_INFO, JSON.stringify({
                            phoneNumber: phoneNumber,
                            loginTime: new Date().toISOString()
                        }));

                        showStatus('ç™»å½•æˆåŠŸï¼', 'success');
                        
                        setTimeout(() => {
                            showBusinessInterface();
                        }, 1000);
                        
                        return true;
                    } else {
                        const errorData = await response.json();
                        showStatus(`ç™»å½•å¤±è´¥: ${errorData.error_description || 'éªŒè¯ç é”™è¯¯'}`, 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showStatus('ç™»å½•æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                    return false;
                } finally {
                    hideLoading('loginBtn', 'ç«‹å³ç™»å½•');
                }
            }

            // éªŒè¯æ‰‹æœºå·
            validatePhoneNumber(phoneNumber) {
                const phoneRegex = /^1[3-9]\d{9}$/;
                return phoneRegex.test(phoneNumber);
            }

            // éªŒè¯éªŒè¯ç 
            validateVerificationCode(code) {
                return code && code.length === 6 && /^\d{6}$/.test(code);
            }

            // å¼€å§‹å€’è®¡æ—¶
            startCooldown() {
                this.sendCodeCooldown = 60;
                this.updateCooldownDisplay();

                this.cooldownTimer = setInterval(() => {
                    this.sendCodeCooldown--;
                    if (this.sendCodeCooldown <= 0) {
                        clearInterval(this.cooldownTimer);
                        this.resetCooldownDisplay();
                    } else {
                        this.updateCooldownDisplay();
                    }
                }, 1000);
            }

            // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
            updateCooldownDisplay() {
                const sendCodeBtn = document.getElementById('sendCodeBtn');
                const sendCodeText = document.getElementById('sendCodeText');
                
                sendCodeBtn.disabled = true;
                sendCodeText.innerHTML = `<span class="countdown">${this.sendCodeCooldown}s</span>`;
            }

            // é‡ç½®å€’è®¡æ—¶æ˜¾ç¤º
            resetCooldownDisplay() {
                const sendCodeBtn = document.getElementById('sendCodeBtn');
                const sendCodeText = document.getElementById('sendCodeText');
                
                sendCodeBtn.disabled = false;
                sendCodeText.textContent = 'å‘é€éªŒè¯ç ';
            }
        }

        // å…¨å±€å®ä¾‹
        const tokenManager = new TokenManager();
        const smsLoginManager = new SmsLoginManager(tokenManager);

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            // æ·»åŠ å›è½¦é”®ç™»å½•æ”¯æŒ
            document.getElementById('verificationCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performLogin();
                }
            });
            
            document.getElementById('phoneNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendSmsCode();
                }
            });
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            if (tokenManager.isTokenValid()) {
                showBusinessInterface();
            } else {
                const refreshToken = tokenManager.getRefreshToken();
                if (refreshToken) {
                    try {
                        await tokenManager.refreshToken();
                        showBusinessInterface();
                    } catch (error) {
                        tokenManager.clearTokens();
                        showLoginForm();
                    }
                } else {
                    showLoginForm();
                }
            }
        }

        // å‘é€çŸ­ä¿¡éªŒè¯ç 
        async function sendSmsCode() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            await smsLoginManager.sendVerificationCode(phoneNumber);
        }

        // æ‰§è¡Œç™»å½•
        async function performLogin() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const verificationCode = document.getElementById('verificationCode').value.trim();
            
            await smsLoginManager.performLogin(phoneNumber, verificationCode);
        }

        // ç™»å‡º
        function logout() {
            tokenManager.clearTokens();
            showStatus('å·²æˆåŠŸç™»å‡º', 'info');
            setTimeout(() => {
                showLoginForm();
            }, 1000);
        }

        // æ˜¾ç¤ºç™»å½•ç•Œé¢
        function showLoginForm() {
            document.getElementById('loginContainer').classList.add('active');
            document.getElementById('businessContainer').classList.remove('active');
            document.getElementById('logoutBtn').style.display = 'none';
            clearForm();
        }

        // æ˜¾ç¤ºä¸šåŠ¡ç•Œé¢
        function showBusinessInterface() {
            document.getElementById('loginContainer').classList.remove('active');
            document.getElementById('businessContainer').classList.add('active');
            document.getElementById('logoutBtn').style.display = 'block';
            
            // æ›´æ–°ç”¨æˆ·æ¬¢è¿ä¿¡æ¯
            updateUserWelcome();
            tokenManager.updateTokenDisplay();
        }

        // æ›´æ–°ç”¨æˆ·æ¬¢è¿ä¿¡æ¯
        function updateUserWelcome() {
            const userInfo = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_INFO);
            if (userInfo) {
                const info = JSON.parse(userInfo);
                const welcomeElement = document.getElementById('userWelcome');
                welcomeElement.textContent = `æ‰‹æœºå·: ${info.phoneNumber} | ç™»å½•æ—¶é—´: ${new Date(info.loginTime).toLocaleString('zh-CN')}`;
            }
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('phoneNumber').value = '';
            document.getElementById('verificationCode').value = '';
            hideStatus();
        }

        // ä¸šåŠ¡åŠŸèƒ½æ¼”ç¤º
        async function viewProfile() {
            const result = await makeAuthenticatedRequest('/api/user/profile');
            if (result.success) {
                alert('ä¸ªäººèµ„æ–™åŠ è½½æˆåŠŸï¼\n\nè¿™é‡Œä¼šæ˜¾ç¤ºç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ã€‚');
            }
        }

        async function viewOrders() {
            const result = await makeAuthenticatedRequest('/api/user/orders');
            if (result.success) {
                alert('è®¢å•ä¿¡æ¯åŠ è½½æˆåŠŸï¼\n\nè¿™é‡Œä¼šæ˜¾ç¤ºç”¨æˆ·çš„è®¢å•åˆ—è¡¨ã€‚');
            }
        }

        async function viewSettings() {
            alert('ç³»ç»Ÿè®¾ç½®\n\nè¿™é‡Œå¯ä»¥é…ç½®å„ç§ä¸ªäººåå¥½è®¾ç½®ã€‚');
        }

        async function viewApiTest() {
            const token = tokenManager.getAccessToken();
            const message = `APIæµ‹è¯•ä¿¡æ¯ï¼š\n\n` +
                           `å½“å‰Access Token: ${token ? token.substring(0, 50) + '...' : 'æ— '}\n` +
                           `TokençŠ¶æ€: ${tokenManager.isTokenValid() ? 'æœ‰æ•ˆ' : 'æ— æ•ˆæˆ–å³å°†è¿‡æœŸ'}\n` +
                           `è‡ªåŠ¨åˆ·æ–°: å·²å¯ç”¨\n\n` +
                           `æ‚¨å¯ä»¥ä½¿ç”¨æ­¤tokenè°ƒç”¨å—ä¿æŠ¤çš„APIæ¥å£ã€‚`;
            alert(message);
        }

        // å‘èµ·å—ä¿æŠ¤çš„APIè¯·æ±‚
        async function makeAuthenticatedRequest(endpoint) {
            try {
                let token = tokenManager.getAccessToken();
                
                // å¦‚æœtokenæ— æ•ˆï¼Œå…ˆå°è¯•åˆ·æ–°
                if (!tokenManager.isTokenValid()) {
                    try {
                        token = await tokenManager.refreshToken();
                    } catch (error) {
                        showStatus('Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                        showLoginForm();
                        return { success: false, error: 'Token expired' };
                    }
                }

                const response = await fetch(`${CONFIG.AUTH_SERVER_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    // Tokenå¯èƒ½å·²å¤±æ•ˆï¼Œå°è¯•åˆ·æ–°
                    try {
                        token = await tokenManager.refreshToken();
                        // é‡æ–°å‘èµ·è¯·æ±‚
                        const retryResponse = await fetch(`${CONFIG.AUTH_SERVER_BASE_URL}${endpoint}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (retryResponse.ok) {
                            return { success: true, data: await retryResponse.json() };
                        }
                    } catch (refreshError) {
                        showStatus('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                        showLoginForm();
                        return { success: false, error: 'Authentication failed' };
                    }
                }

                if (response.ok) {
                    return { success: true, data: await response.json() };
                } else {
                    return { success: false, error: await response.text() };
                }
            } catch (error) {
                console.error('API request error:', error);
                showStatus('APIè¯·æ±‚å¤±è´¥', 'error');
                return { success: false, error: error.message };
            }
        }

        // å·¥å…·å‡½æ•°
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('loginStatus');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    hideStatus();
                }, 3000);
            }
        }

        function hideStatus() {
            const statusElement = document.getElementById('loginStatus');
            statusElement.style.display = 'none';
        }

        function showLoading(buttonId, loadingText) {
            const button = document.getElementById(buttonId);
            const textElement = button.querySelector('span');
            
            button.disabled = true;
            textElement.innerHTML = `<span class="loading"></span>${loadingText}`;
        }

        function hideLoading(buttonId, originalText) {
            const button = document.getElementById(buttonId);
            const textElement = button.querySelector('span');
            
            button.disabled = false;
            textElement.textContent = originalText;
        }

        // æ‰‹åŠ¨åˆ·æ–°TokenåŠŸèƒ½
        async function manualRefreshToken() {
            const refreshBtn = document.getElementById('manualRefreshBtn');
            const refreshBtnText = document.getElementById('refreshBtnText');
            const originalText = refreshBtnText.textContent;

            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                if (!tokenManager.getRefreshToken()) {
                    showStatus('è¯·å…ˆç™»å½•åå†å°è¯•åˆ·æ–°Token', 'warning');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                refreshBtn.disabled = true;
                refreshBtnText.innerHTML = '<span class="loading"></span>æ­£åœ¨åˆ·æ–°...';

                // æ‰§è¡Œåˆ·æ–°
                await tokenManager.refreshTokenWithProcess();
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                showStatus('Tokenåˆ·æ–°æˆåŠŸï¼', 'success');
                
            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                showStatus(`Tokenåˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
                
                // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œè·³è½¬å›ç™»å½•é¡µé¢
                if (error.message.includes('refresh token') || error.message.includes('expired')) {
                    setTimeout(() => {
                        showLoginForm();
                    }, 2000);
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                refreshBtnText.textContent = originalText;
            }
        }
    </script>
</body>
</html>