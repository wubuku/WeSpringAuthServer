# Agent Instructions for WeSpringAuthServer

## ğŸš¨ CRITICAL: Always Check .cursorrules First!

**BEFORE making ANY code changes, modifications, or providing development advice, you MUST:**

1. **Read `.cursorrules` file** - This contains essential security principles and development rules for this enterprise-grade authentication server
2. **Follow ALL security guidelines** specified in `.cursorrules` 
3. **Apply the architectural patterns** and best practices defined there

---

## ğŸ“‹ Project Overview

**WeSpringAuthServer** is an enterprise-grade OAuth2 Authorization Server built on Spring Authorization Server 1.5.0. It's a **fully independent** Spring Boot 3.2.0 application that provides comprehensive authentication and authorization services.

### ğŸ—ï¸ Current Architecture Status
- âœ… **Independent Project**: Fully separated from parent projects, uses `spring-boot-starter-parent`
- âœ… **Production Ready**: Comprehensive security fixes completed (Phase 1 & 2)
- âœ… **Multi-Authentication**: Username/Password, SMS, WeChat login support
- âœ… **Hybrid Architecture**: Session-based authorization flow + JWT-based API access
- âœ… **Cookie Security**: HttpOnly Cookie implementation for refresh_token protection
- âœ… **Enterprise Security**: Complete permission system with `ROLE_ADMIN` protection

### ğŸ”§ Technology Stack
- **Java**: 17 (LTS)
- **Spring Boot**: 3.2.0
- **Spring Security**: 6.2.0  
- **Spring Authorization Server**: 1.5.0
- **Database**: PostgreSQL with JDBC Session Store
- **Authentication**: Multi-provider (Username/Password, SMS, WeChat)
- **Token Strategy**: JWT (1h access + 24h refresh) with HttpOnly Cookie security

---

## ğŸ”’ Security Architecture (CRITICAL)

### Permission Model
```
ROLE_ADMIN (Super Admin)
â”œâ”€â”€ All management APIs (/api/**, /auth-srv/**)
â”œâ”€â”€ All management pages (user-management, group-management, etc.)
â”œâ”€â”€ Authority management
â””â”€â”€ Pre-registration functionality

Granular Permissions (Future)
â”œâ”€â”€ Users_Read (User management view)
â”œâ”€â”€ Roles_Read (Group management view)
â””â”€â”€ [Other specific permissions]
```

### Security Layers
1. **API Security**: All `/api/**` and `/auth-srv/**` require `ROLE_ADMIN`
2. **Page Security**: Management pages use `sec:authorize="hasRole('ADMIN')"`
3. **Method Security**: `@PreAuthorize` annotations where needed
4. **Data Security**: Sensitive data logging protection (`[HIDDEN]`)
5. **Cookie Security**: HttpOnly refresh_token storage

### Recent Security Fixes (Completed)
- âœ… **Critical**: Fixed password logging in plaintext
- âœ… **Critical**: Added missing API permission controls
- âœ… **High**: Protected authority-settings page
- âœ… **Medium**: Enhanced security headers (no HSTS - load balancer handles HTTPS)
- âœ… **Medium**: File upload security validation

---

## ğŸ› ï¸ Development Guidelines

### Security-First Development
```java
// âœ… CORRECT: API Controller
@RestController
@RequestMapping("/api/users")
public class UserApiController {
    // Already protected by SecurityConfig ROLE_ADMIN requirement
}

// âœ… CORRECT: Page Template  
<div sec:authorize="hasRole('ADMIN')">
    <!-- Admin-only content -->
</div>

// âœ… CORRECT: Logging
logger.debug("Password validation for user: {}, result: [HIDDEN]", username);
```

### Configuration Patterns
```yaml
# âœ… CORRECT: OAuth2 Cookie Security
oauth2:
  cookie:
    domain: ${OAUTH2_COOKIE_DOMAIN:}  # .example.com for production
    secure: ${OAUTH2_COOKIE_SECURE:false}  # true for production HTTPS
    same-site: ${OAUTH2_COOKIE_SAME_SITE:Lax}
  security:
    cookie-mode-enabled: true
    hide-client-secret: true
    refresh-token-strategy: cookie
```

### Database Safety
```java
// âœ… CORRECT: Parameterized queries
jdbcTemplate.update(
    "UPDATE users SET enabled = ? WHERE username = ? AND username != ?",
    enabled, username, currentUsername
);

// âŒ WRONG: String concatenation (SQL injection risk)
String sql = "UPDATE users SET enabled = " + enabled + " WHERE username = '" + username + "'";
```

---

## ğŸ“ Key Project Structure

```
src/main/java/org/dddml/ffvtraceability/auth/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ SecurityConfig.java           # Multi-layer security configuration
â”‚   â”œâ”€â”€ AuthorizationServerConfig.java # OAuth2 server setup
â”‚   â”œâ”€â”€ CookieSecurityConfig.java     # HttpOnly cookie management
â”‚   â””â”€â”€ WebMvcConfig.java            # CORS and web configuration
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ *ApiController.java          # REST APIs (ROLE_ADMIN protected)
â”‚   â”œâ”€â”€ *ViewController.java         # Page controllers
â”‚   â””â”€â”€ OAuth2TestController.java    # OAuth2 testing utilities
â”œâ”€â”€ authentication/                   # Custom auth providers
â”œâ”€â”€ service/                         # Business logic
â””â”€â”€ security/                        # Security utilities

src/main/resources/
â”œâ”€â”€ templates/                       # Thymeleaf templates with sec:authorize
â”œâ”€â”€ application.yml                  # Configuration with security settings
â”œâ”€â”€ data.sql                        # Initial data with ROLE_ADMIN setup
â””â”€â”€ schema.sql                      # Database schema
```

---

## ğŸ¯ Common Tasks & Patterns

### Adding New Admin API
```java
@RestController
@RequestMapping("/api/new-feature")  // Automatically protected by SecurityConfig
public class NewFeatureController {
    // No additional @PreAuthorize needed - SecurityConfig handles it
}
```

### Adding New Admin Page
```html
<!-- Template: new-admin-page.html -->
<div class="container" sec:authorize="hasRole('ADMIN')">
    <!-- Page content only visible to ROLE_ADMIN -->
</div>
```

### Adding New User Authority
```sql
-- In data.sql or migration
INSERT INTO authorities (username, authority) 
VALUES ('username', 'ROLE_ADMIN');
```

### OAuth2 Client Configuration
```sql
-- In data.sql - Client with Cookie security
INSERT INTO oauth2_registered_client (...) VALUES (
    'client-id',
    '{noop}secret',  -- Backend managed, never exposed to frontend
    'authorization_code,refresh_token',
    'http://localhost:3000/callback',
    'read,write',
    'PT1H',  -- 1 hour access token
    'PT24H'  -- 24 hour refresh token (stored in HttpOnly cookie)
);
```

---

## ğŸ” Testing & Validation

### Security Testing Scripts
```bash
# Test all security configurations
./scripts/test-api-security.sh
./scripts/test-cookie-security.sh  
./scripts/test-permissions.sh

# Test authentication flows
./scripts/test-sms-login.sh
./scripts/test-wechat-login.sh
./scripts/verify-oauth2-security.sh
```

### OAuth2 Flow Testing
```bash
# Start server
./start.sh

# Test OAuth2 authorization code flow
curl -X POST http://localhost:9000/oauth2/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code&code=...&client_id=..."
```

---

## ğŸ“š Key Documentation References

### Recent Completion Reports
- `docs/drafts/Phase2-OAuth2-Cookie-Security-Implementation-Complete.md` - Cookie security implementation
- `docs/drafts/security-fixes-summary.md` - Comprehensive security fixes
- `docs/drafts/project-independence-status.md` - Project independence status

### Architecture Analysis  
- `docs/drafts/oauth2-session-vs-jwt-comprehensive-analysis.md` - Hybrid architecture explanation
- `docs/drafts/STATELESS-migration-progress.md` - JWT enhancement progress

### Integration Guides
- `docs/oauth2-client-integration-guide.md` - Client integration patterns
- `docs/resource-server-integration-guide.md` - Resource server setup
- `example-resource-server/` - Working resource server example

---

## âš ï¸ Critical Reminders

### Security Principles from .cursorrules
- ğŸ”’ **All admin APIs**: Must have `ROLE_ADMIN` protection via SecurityConfig
- ğŸ›¡ï¸ **All admin pages**: Must use `sec:authorize="hasRole('ADMIN')"`
- ğŸ” **Sensitive logging**: Never log passwords, use `[HIDDEN]` replacement
- ğŸ“ **SQL safety**: Always use parameterized queries with JdbcTemplate
- ğŸŒ **HTTPS handling**: Production uses load balancer, app runs HTTP
- âš ï¸ **No security bypasses**: Any "temporary" modifications can cause production issues

### Architecture Considerations
- **Hybrid Design**: Session for authorization flow, JWT for API access (by design)
- **Cookie Security**: refresh_token stored in HttpOnly cookies, never exposed to frontend
- **Permission Strategy**: Conservative approach - admin functions require `ROLE_ADMIN`
- **Database Sessions**: Uses JDBC session store for authorization flow state management

---

## ğŸš€ Quick Start for New Tasks

1. **Check `.cursorrules`** for security requirements âœ…
2. **Review existing patterns** in similar controllers/services âœ…
3. **Apply security-first approach** (permissions, logging, validation) âœ…
4. **Test with security scripts** before considering complete âœ…
5. **Update documentation** if adding new features âœ…

---

*Remember: This is an enterprise authentication server - every change affects security for all users. When in doubt, choose the more secure option.*