# Agent Instructions for WeSpringAuthServer

## 🚨 CRITICAL: Always Check .cursorrules First!

**BEFORE making ANY code changes, modifications, or providing development advice, you MUST:**

1. **Read `.cursorrules` file** - This contains essential security principles and development rules for this enterprise-grade authentication server
2. **Follow ALL security guidelines** specified in `.cursorrules` 
3. **Apply the architectural patterns** and best practices defined there

---

## 📋 Project Overview

**WeSpringAuthServer** is an enterprise-grade OAuth2 Authorization Server built on Spring Authorization Server 1.5.0. It's a **fully independent** Spring Boot 3.2.0 application that provides comprehensive authentication and authorization services.

### 🏗️ Current Architecture Status
- ✅ **Independent Project**: Fully separated from parent projects, uses `spring-boot-starter-parent`
- ✅ **Production Ready**: Comprehensive security fixes completed (Phase 1 & 2)
- ✅ **Multi-Authentication**: Username/Password, SMS, WeChat login support
- ✅ **Hybrid Architecture**: Session-based authorization flow + JWT-based API access
- ✅ **Cookie Security**: HttpOnly Cookie implementation for refresh_token protection
- ✅ **Enterprise Security**: Complete permission system with `ROLE_ADMIN` protection

### 🔧 Technology Stack
- **Java**: 17 (LTS)
- **Spring Boot**: 3.2.0
- **Spring Security**: 6.2.0  
- **Spring Authorization Server**: 1.5.0
- **Database**: PostgreSQL with JDBC Session Store
- **Authentication**: Multi-provider (Username/Password, SMS, WeChat)
- **Token Strategy**: JWT (1h access + 24h refresh) with HttpOnly Cookie security

---

## 🔒 Security Architecture (CRITICAL)

### Permission Model
```
ROLE_ADMIN (Super Admin)
├── All management APIs (/api/**, /auth-srv/**)
├── All management pages (user-management, group-management, etc.)
├── Authority management
└── Pre-registration functionality

Granular Permissions (Future)
├── Users_Read (User management view)
├── Roles_Read (Group management view)
└── [Other specific permissions]
```

### Security Layers
1. **API Security**: All `/api/**` and `/auth-srv/**` require `ROLE_ADMIN`
2. **Page Security**: Management pages use `sec:authorize="hasRole('ADMIN')"`
3. **Method Security**: `@PreAuthorize` annotations where needed
4. **Data Security**: Sensitive data logging protection (`[HIDDEN]`)
5. **Cookie Security**: HttpOnly refresh_token storage

### Recent Security Fixes (Completed)
- ✅ **Critical**: Fixed password logging in plaintext
- ✅ **Critical**: Added missing API permission controls
- ✅ **High**: Protected authority-settings page
- ✅ **Medium**: Enhanced security headers (no HSTS - load balancer handles HTTPS)
- ✅ **Medium**: File upload security validation

---

## 🛠️ Development Guidelines

### Security-First Development
```java
// ✅ CORRECT: API Controller
@RestController
@RequestMapping("/api/users")
public class UserApiController {
    // Already protected by SecurityConfig ROLE_ADMIN requirement
}

// ✅ CORRECT: Page Template  
<div sec:authorize="hasRole('ADMIN')">
    <!-- Admin-only content -->
</div>

// ✅ CORRECT: Logging
logger.debug("Password validation for user: {}, result: [HIDDEN]", username);
```

### Configuration Patterns
```yaml
# ✅ CORRECT: OAuth2 Cookie Security
oauth2:
  cookie:
    domain: ${OAUTH2_COOKIE_DOMAIN:}  # .example.com for production
    secure: ${OAUTH2_COOKIE_SECURE:false}  # true for production HTTPS
    same-site: ${OAUTH2_COOKIE_SAME_SITE:Lax}
  security:
    cookie-mode-enabled: true
    hide-client-secret: true
    refresh-token-strategy: cookie
```

### Database Safety
```java
// ✅ CORRECT: Parameterized queries
jdbcTemplate.update(
    "UPDATE users SET enabled = ? WHERE username = ? AND username != ?",
    enabled, username, currentUsername
);

// ❌ WRONG: String concatenation (SQL injection risk)
String sql = "UPDATE users SET enabled = " + enabled + " WHERE username = '" + username + "'";
```

---

## 📁 Key Project Structure

```
src/main/java/org/dddml/ffvtraceability/auth/
├── config/
│   ├── SecurityConfig.java           # Multi-layer security configuration
│   ├── AuthorizationServerConfig.java # OAuth2 server setup
│   ├── CookieSecurityConfig.java     # HttpOnly cookie management
│   └── WebMvcConfig.java            # CORS and web configuration
├── controller/
│   ├── *ApiController.java          # REST APIs (ROLE_ADMIN protected)
│   ├── *ViewController.java         # Page controllers
│   └── OAuth2TestController.java    # OAuth2 testing utilities
├── authentication/                   # Custom auth providers
├── service/                         # Business logic
└── security/                        # Security utilities

src/main/resources/
├── templates/                       # Thymeleaf templates with sec:authorize
├── application.yml                  # Configuration with security settings
├── data.sql                        # Initial data with ROLE_ADMIN setup
└── schema.sql                      # Database schema
```

---

## 🎯 Common Tasks & Patterns

### Adding New Admin API
```java
@RestController
@RequestMapping("/api/new-feature")  // Automatically protected by SecurityConfig
public class NewFeatureController {
    // No additional @PreAuthorize needed - SecurityConfig handles it
}
```

### Adding New Admin Page
```html
<!-- Template: new-admin-page.html -->
<div class="container" sec:authorize="hasRole('ADMIN')">
    <!-- Page content only visible to ROLE_ADMIN -->
</div>
```

### Adding New User Authority
```sql
-- In data.sql or migration
INSERT INTO authorities (username, authority) 
VALUES ('username', 'ROLE_ADMIN');
```

### OAuth2 Client Configuration
```sql
-- In data.sql - Client with Cookie security
INSERT INTO oauth2_registered_client (...) VALUES (
    'client-id',
    '{noop}secret',  -- Backend managed, never exposed to frontend
    'authorization_code,refresh_token',
    'http://localhost:3000/callback',
    'read,write',
    'PT1H',  -- 1 hour access token
    'PT24H'  -- 24 hour refresh token (stored in HttpOnly cookie)
);
```

---

## 🔍 Testing & Validation

### Security Testing Scripts
```bash
# Test all security configurations
./scripts/test-api-security.sh
./scripts/test-cookie-security.sh  
./scripts/test-permissions.sh

# Test authentication flows
./scripts/test-sms-login.sh
./scripts/test-wechat-login.sh
./scripts/verify-oauth2-security.sh
```

### OAuth2 Flow Testing
```bash
# Start server
./start.sh

# Test OAuth2 authorization code flow
curl -X POST http://localhost:9000/oauth2/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code&code=...&client_id=..."
```

---

## 📚 Key Documentation References

### Recent Completion Reports
- `docs/drafts/Phase2-OAuth2-Cookie-Security-Implementation-Complete.md` - Cookie security implementation
- `docs/drafts/security-fixes-summary.md` - Comprehensive security fixes
- `docs/drafts/project-independence-status.md` - Project independence status

### Architecture Analysis  
- `docs/drafts/oauth2-session-vs-jwt-comprehensive-analysis.md` - Hybrid architecture explanation
- `docs/drafts/STATELESS-migration-progress.md` - JWT enhancement progress

### Integration Guides
- `docs/oauth2-client-integration-guide.md` - Client integration patterns
- `docs/resource-server-integration-guide.md` - Resource server setup
- `example-resource-server/` - Working resource server example

---

## ⚠️ Critical Reminders

### Security Principles from .cursorrules
- 🔒 **All admin APIs**: Must have `ROLE_ADMIN` protection via SecurityConfig
- 🛡️ **All admin pages**: Must use `sec:authorize="hasRole('ADMIN')"`
- 🔐 **Sensitive logging**: Never log passwords, use `[HIDDEN]` replacement
- 📝 **SQL safety**: Always use parameterized queries with JdbcTemplate
- 🌐 **HTTPS handling**: Production uses load balancer, app runs HTTP
- ⚠️ **No security bypasses**: Any "temporary" modifications can cause production issues

### Architecture Considerations
- **Hybrid Design**: Session for authorization flow, JWT for API access (by design)
- **Cookie Security**: refresh_token stored in HttpOnly cookies, never exposed to frontend
- **Permission Strategy**: Conservative approach - admin functions require `ROLE_ADMIN`
- **Database Sessions**: Uses JDBC session store for authorization flow state management

---

## 🚀 Quick Start for New Tasks

1. **Check `.cursorrules`** for security requirements ✅
2. **Review existing patterns** in similar controllers/services ✅
3. **Apply security-first approach** (permissions, logging, validation) ✅
4. **Test with security scripts** before considering complete ✅
5. **Update documentation** if adding new features ✅

---

*Remember: This is an enterprise authentication server - every change affects security for all users. When in doubt, choose the more secure option.*