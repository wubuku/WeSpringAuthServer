# Auth Server æ•°æ®åº“é›†æˆæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•ç›´æ¥é€šè¿‡PostgreSQLæ•°æ®åº“é›†æˆAuth Serveré¡¹ç›®ï¼ŒåŒ…æ‹¬ç”¨æˆ·æƒé™æ¢å¤ã€ç”¨æˆ·æ ‡è¯†æŸ¥è¯¢ç­‰å¸¸è§åœºæ™¯ã€‚

## ğŸ—„ï¸ æ•°æ®åº“æ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    username VARCHAR(50) NOT NULL PRIMARY KEY,  -- ç”¨æˆ·IDï¼ˆå³ç”¨æˆ·åï¼‰
    password VARCHAR(100) NOT NULL,             -- åŠ å¯†å¯†ç 
    enabled BOOLEAN NOT NULL,                   -- æ˜¯å¦å¯ç”¨
    password_change_required BOOLEAN DEFAULT true,
    password_last_changed TIMESTAMPTZ DEFAULT NULL,
    first_login BOOLEAN DEFAULT true,
    -- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    first_name VARCHAR(50) DEFAULT NULL,
    last_name VARCHAR(50) DEFAULT NULL,
    email VARCHAR(50) DEFAULT NULL,
    mobile_number VARCHAR(20) DEFAULT NULL,
    -- å…¶ä»–å­—æ®µ...
    created_at TIMESTAMPTZ DEFAULT NULL,
    updated_at TIMESTAMPTZ DEFAULT NULL,
    referrer_id VARCHAR(255) DEFAULT NULL
);
```

#### 2. æƒé™è¡¨ (authorities)
```sql
CREATE TABLE authorities (
    username VARCHAR(50) NOT NULL,
    authority VARCHAR(50) NOT NULL,
    CONSTRAINT fk_authorities_users FOREIGN KEY(username) REFERENCES users(username)
);
```

#### 3. ç”¨æˆ·ç»„è¡¨ (groups, group_members, group_authorities)
```sql
-- ç»„å®šä¹‰
CREATE TABLE groups (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    group_name VARCHAR(50) NOT NULL UNIQUE,
    enabled BOOLEAN NOT NULL DEFAULT TRUE,
    description VARCHAR(255) DEFAULT NULL
);

-- ç»„æˆå‘˜å…³ç³»
CREATE TABLE group_members (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    group_id BIGINT NOT NULL,
    CONSTRAINT fk_group_members_group FOREIGN KEY(group_id) REFERENCES groups(id)
);

-- ç»„æƒé™
CREATE TABLE group_authorities (
    group_id BIGINT NOT NULL,
    authority VARCHAR(50) NOT NULL,
    CONSTRAINT fk_group_authorities_group FOREIGN KEY(group_id) REFERENCES groups(id)
);
```

#### 4. ç”¨æˆ·æ ‡è¯†è¡¨ (user_identifications) â­
```sql
CREATE TABLE user_identifications (
    user_identification_type_id VARCHAR(50) NOT NULL,  -- æ ‡è¯†ç±»å‹
    username VARCHAR(50) NOT NULL,                     -- ç”¨æˆ·å
    identifier VARCHAR(100) NOT NULL,                  -- æ ‡è¯†å€¼
    verified BOOLEAN DEFAULT FALSE,                    -- æ˜¯å¦å·²éªŒè¯
    verified_at TIMESTAMPTZ DEFAULT NULL,              -- éªŒè¯æ—¶é—´
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_identification_type_id, username),
    CONSTRAINT fk_user_identifications_users FOREIGN KEY(username) REFERENCES users(username)
);
```

#### 5. æƒé™å®šä¹‰è¡¨ (authority_definitions)
```sql
CREATE TABLE authority_definitions (
    authority_id VARCHAR(50) NOT NULL PRIMARY KEY,
    description VARCHAR(200),
    enabled BOOLEAN DEFAULT NULL
);
```

## ğŸ” å¸¸è§æŸ¥è¯¢åœºæ™¯

### 1. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æ ‡è¯†ä¿¡æ¯

#### æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰æ ‡è¯†
```sql
-- æŸ¥è¯¢ç”¨æˆ· 'admin' çš„æ‰€æœ‰æ ‡è¯†
SELECT 
    user_identification_type_id AS æ ‡è¯†ç±»å‹,
    identifier AS æ ‡è¯†å€¼,
    verified AS æ˜¯å¦éªŒè¯,
    verified_at AS éªŒè¯æ—¶é—´,
    created_at AS åˆ›å»ºæ—¶é—´
FROM user_identifications 
WHERE username = 'admin'
ORDER BY user_identification_type_id;
```

#### æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·çš„æ ‡è¯†æ±‡æ€»
```sql
-- æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·çš„æ ‡è¯†æ±‡æ€»ï¼ˆæ ¼å¼åŒ–æ˜¾ç¤ºï¼‰
SELECT 
    username AS ç”¨æˆ·å,
    STRING_AGG(
        user_identification_type_id || ':' || identifier || 
        CASE 
            WHEN verified IS TRUE THEN '(å·²éªŒè¯)'
            WHEN verified IS FALSE THEN '(æœªéªŒè¯)'
            ELSE '(çŠ¶æ€æœªçŸ¥)'
        END, 
        ', ' ORDER BY user_identification_type_id
    ) AS ç”¨æˆ·æ ‡è¯†
FROM user_identifications
GROUP BY username
ORDER BY username;
```

### 2. ç”¨æˆ·æ ‡è¯†ç±»å‹è¯´æ˜

å½“å‰ç³»ç»Ÿæ”¯æŒçš„æ ‡è¯†ç±»å‹åŒ…æ‹¬ï¼š

| æ ‡è¯†ç±»å‹               | è¯´æ˜               | ç¤ºä¾‹å€¼                 | æ¥æº           |
| ---------------------- | ------------------ | ---------------------- | -------------- |
| `MOBILE_NUMBER`        | æ‰‹æœºå·ï¼ˆçŸ­ä¿¡ç™»å½•ï¼‰ | 13800138000            | SMSç™»å½•éªŒè¯    |
| `WECHAT_OPENID`        | å¾®ä¿¡OpenID         | oABC123def456ghi789jkl | å¾®ä¿¡å°ç¨‹åºç™»å½• |
| `WECHAT_UNIONID`       | å¾®ä¿¡UnionID        | uUNI567opq890rst123uvw | å¾®ä¿¡å¼€æ”¾å¹³å°   |
| `WECHAT_MOBILE_NUMBER` | å¾®ä¿¡æˆæƒæ‰‹æœºå·     | 13700137000            | å¾®ä¿¡æˆæƒè·å–   |
| `EMAIL`                | é‚®ç®±åœ°å€           | user@example.com       | ç”¨æˆ·æ³¨å†Œ/ç»‘å®š  |
| `ID_CARD`              | èº«ä»½è¯å·           | 11010119800101001X     | å®åè®¤è¯       |

#### æŒ‰æ ‡è¯†ç±»å‹æŸ¥è¯¢ç”¨æˆ·
```sql
-- æŸ¥è¯¢æ‰€æœ‰ç»‘å®šäº†å¾®ä¿¡OpenIDçš„ç”¨æˆ·
SELECT 
    ui.username,
    ui.identifier AS wechat_openid,
    ui.verified,
    u.enabled,
    u.first_name,
    u.last_name
FROM user_identifications ui
JOIN users u ON ui.username = u.username
WHERE ui.user_identification_type_id = 'WECHAT_OPENID'
ORDER BY ui.created_at DESC;

-- æŸ¥è¯¢æ‰€æœ‰é€šè¿‡æ‰‹æœºå·æ³¨å†Œçš„ç”¨æˆ·
SELECT 
    ui.username,
    ui.identifier AS mobile_number,
    ui.verified,
    u.enabled,
    u.created_at
FROM user_identifications ui
JOIN users u ON ui.username = u.username
WHERE ui.user_identification_type_id = 'MOBILE_NUMBER'
ORDER BY ui.created_at DESC;
```

#### æŸ¥æ‰¾é‡å¤æ ‡è¯†
```sql
-- æŸ¥æ‰¾å¯èƒ½çš„é‡å¤æ‰‹æœºå·ç»‘å®š
SELECT 
    identifier AS mobile_number,
    COUNT(*) AS user_count,
    STRING_AGG(username, ', ') AS usernames
FROM user_identifications 
WHERE user_identification_type_id = 'MOBILE_NUMBER'
GROUP BY identifier
HAVING COUNT(*) > 1;
```

### 3. ç”¨æˆ·æƒé™æŸ¥è¯¢

#### æŸ¥è¯¢ç”¨æˆ·çš„å®Œæ•´æƒé™ä¿¡æ¯
```sql
-- æŸ¥è¯¢ç”¨æˆ·çš„ç›´æ¥æƒé™å’Œç»„æƒé™
WITH user_direct_authorities AS (
    SELECT username, authority, 'direct' as source
    FROM authorities
    WHERE username = 'admin'
),
user_group_authorities AS (
    SELECT 
        gm.username, 
        ga.authority, 
        'group:' || g.group_name as source
    FROM group_members gm
    JOIN groups g ON gm.group_id = g.id
    JOIN group_authorities ga ON g.id = ga.group_id
    WHERE gm.username = 'admin' AND g.enabled = true
)
SELECT 
    username,
    authority,
    source
FROM user_direct_authorities
UNION ALL
SELECT 
    username,
    authority,
    source
FROM user_group_authorities
ORDER BY authority, source;
```

#### æŸ¥è¯¢ç”¨æˆ·æ‰€å±çš„ç»„
```sql
-- æŸ¥è¯¢ç”¨æˆ·æ‰€å±çš„æ‰€æœ‰ç»„
SELECT 
    u.username,
    g.group_name,
    g.description,
    g.enabled AS group_enabled
FROM users u
JOIN group_members gm ON u.username = gm.username
JOIN groups g ON gm.group_id = g.id
WHERE u.username = 'admin'
ORDER BY g.group_name;
```

### 4. æƒé™æ¢å¤åœºæ™¯

#### ä»"ä»åº“"æ¢å¤ç”¨æˆ·æƒé™
```sql
-- å‡è®¾ä»å¦ä¸€ä¸ªæ•°æ®åº“æ¢å¤æƒé™ï¼Œå…ˆæŸ¥è¯¢ç›®æ ‡ç”¨æˆ·çš„æƒé™ç»“æ„
-- 1. å¯¼å‡ºç”¨æˆ·çš„ç»„æˆå‘˜å…³ç³»
SELECT 
    gm.username,
    g.group_name,
    g.id as group_id
FROM group_members gm
JOIN groups g ON gm.group_id = g.id
WHERE gm.username IN ('user1', 'user2', 'user3')  -- æŒ‡å®šè¦æ¢å¤çš„ç”¨æˆ·
ORDER BY gm.username, g.group_name;

-- 2. å¯¼å‡ºç”¨æˆ·çš„ç›´æ¥æƒé™
SELECT 
    username,
    authority
FROM authorities
WHERE username IN ('user1', 'user2', 'user3')  -- æŒ‡å®šè¦æ¢å¤çš„ç”¨æˆ·
ORDER BY username, authority;

-- 3. å¯¼å‡ºç”¨æˆ·çš„æ ‡è¯†ä¿¡æ¯
SELECT 
    username,
    user_identification_type_id,
    identifier,
    verified,
    verified_at
FROM user_identifications
WHERE username IN ('user1', 'user2', 'user3')  -- æŒ‡å®šè¦æ¢å¤çš„ç”¨æˆ·
ORDER BY username, user_identification_type_id;
```

#### æ‰¹é‡æ¢å¤æƒé™çš„SQLæ¨¡æ¿
```sql
-- æ¢å¤ç»„æˆå‘˜å…³ç³»ï¼ˆéœ€è¦å…ˆç¡®ä¿ç»„å­˜åœ¨ï¼‰
INSERT INTO group_members (username, group_id)
SELECT 'target_username', id 
FROM groups 
WHERE group_name = 'TARGET_GROUP_NAME'
ON CONFLICT DO NOTHING;

-- æ¢å¤ç›´æ¥æƒé™
INSERT INTO authorities (username, authority) 
VALUES ('target_username', 'TARGET_AUTHORITY')
ON CONFLICT (username, authority) DO NOTHING;

-- æ¢å¤ç”¨æˆ·æ ‡è¯†
INSERT INTO user_identifications (
    user_identification_type_id, 
    username, 
    identifier, 
    verified, 
    verified_at
) VALUES (
    'MOBILE_NUMBER', 
    'target_username', 
    '13800138000', 
    true, 
    CURRENT_TIMESTAMP
) ON CONFLICT (user_identification_type_id, username) DO UPDATE SET
    identifier = EXCLUDED.identifier,
    verified = EXCLUDED.verified,
    verified_at = EXCLUDED.verified_at,
    updated_at = CURRENT_TIMESTAMP;
```

### 5. ç”¨æˆ·æ’æŸ¥å’Œåˆ†æ

#### æŸ¥è¯¢ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯
```sql
-- æŸ¥è¯¢ç”¨æˆ·çš„å®Œæ•´æ¡£æ¡ˆï¼ˆåŒ…æ‹¬åŸºæœ¬ä¿¡æ¯ã€æƒé™ã€æ ‡è¯†ï¼‰
SELECT 
    u.username,
    u.enabled,
    u.first_name,
    u.last_name,
    u.email,
    u.mobile_number,
    u.created_at,
    u.password_change_required,
    u.first_login,
    -- ç»„ä¿¡æ¯
    STRING_AGG(DISTINCT g.group_name, ', ') as groups,
    -- ç›´æ¥æƒé™
    STRING_AGG(DISTINCT a.authority, ', ') as direct_authorities,
    -- æ ‡è¯†ä¿¡æ¯
    STRING_AGG(DISTINCT 
        CASE WHEN ui.user_identification_type_id IS NOT NULL THEN
            ui.user_identification_type_id || ':' || ui.identifier || 
            CASE 
                WHEN ui.verified IS TRUE THEN '(âœ“)'
                WHEN ui.verified IS FALSE THEN '(âœ—)'
                ELSE '(?)'
            END
        END, ', ') as identifications
FROM users u
LEFT JOIN group_members gm ON u.username = gm.username
LEFT JOIN groups g ON gm.group_id = g.id AND g.enabled = true
LEFT JOIN authorities a ON u.username = a.username
LEFT JOIN user_identifications ui ON u.username = ui.username
WHERE u.username = 'admin'  -- æ›¿æ¢ä¸ºç›®æ ‡ç”¨æˆ·å
GROUP BY u.username, u.enabled, u.first_name, u.last_name, u.email, 
         u.mobile_number, u.created_at, u.password_change_required, u.first_login;
```

#### æŸ¥è¯¢å¼‚å¸¸ç”¨æˆ·
```sql
-- æŸ¥è¯¢å¯èƒ½çš„å¼‚å¸¸ç”¨æˆ·
-- 1. æ²¡æœ‰ä»»ä½•æƒé™çš„ç”¨æˆ·
SELECT u.username, u.enabled, u.created_at
FROM users u
LEFT JOIN authorities a ON u.username = a.username
LEFT JOIN group_members gm ON u.username = gm.username
WHERE u.username != '*'  -- æ’é™¤ç‰¹æ®Šç”¨æˆ·
  AND a.username IS NULL 
  AND gm.username IS NULL
ORDER BY u.created_at;

-- 2. æœ‰å¤šä¸ªç›¸åŒç±»å‹æ ‡è¯†çš„ç”¨æˆ·ï¼ˆæ•°æ®å¼‚å¸¸ï¼‰
SELECT 
    username,
    user_identification_type_id,
    COUNT(*) as count,
    STRING_AGG(identifier, ', ') as identifiers
FROM user_identifications
GROUP BY username, user_identification_type_id
HAVING COUNT(*) > 1;

-- 3. æ ‡è¯†æœªéªŒè¯çš„ç”¨æˆ·
SELECT 
    ui.username,
    ui.user_identification_type_id,
    ui.identifier,
    ui.created_at,
    u.enabled
FROM user_identifications ui
JOIN users u ON ui.username = u.username
WHERE ui.verified = false
ORDER BY ui.created_at DESC;
```

## ğŸ”§ æ•°æ®ç»´æŠ¤æ“ä½œ

### ç”¨æˆ·æ ‡è¯†ç®¡ç†

#### æ·»åŠ ç”¨æˆ·æ ‡è¯†
```sql
-- ä¸ºç”¨æˆ·æ·»åŠ æ‰‹æœºå·æ ‡è¯†
INSERT INTO user_identifications (
    user_identification_type_id, 
    username, 
    identifier, 
    verified, 
    verified_at
) VALUES (
    'MOBILE_NUMBER', 
    'target_user', 
    '13800138000', 
    true, 
    CURRENT_TIMESTAMP
) ON CONFLICT (user_identification_type_id, username) DO UPDATE SET
    identifier = EXCLUDED.identifier,
    verified = EXCLUDED.verified,
    verified_at = EXCLUDED.verified_at,
    updated_at = CURRENT_TIMESTAMP;
```

#### éªŒè¯ç”¨æˆ·æ ‡è¯†
```sql
-- å°†ç”¨æˆ·çš„é‚®ç®±æ ‡è¯†æ ‡è®°ä¸ºå·²éªŒè¯
UPDATE user_identifications 
SET verified = true, 
    verified_at = CURRENT_TIMESTAMP,
    updated_at = CURRENT_TIMESTAMP
WHERE username = 'target_user' 
  AND user_identification_type_id = 'EMAIL';
```

#### åˆ é™¤ç”¨æˆ·æ ‡è¯†
```sql
-- åˆ é™¤ç”¨æˆ·çš„ç‰¹å®šæ ‡è¯†
DELETE FROM user_identifications 
WHERE username = 'target_user' 
  AND user_identification_type_id = 'OLD_IDENTIFICATION_TYPE';
```

### æƒé™ç®¡ç†

#### æ·»åŠ ç”¨æˆ·åˆ°ç»„
```sql
-- å°†ç”¨æˆ·æ·»åŠ åˆ°ç®¡ç†å‘˜ç»„
INSERT INTO group_members (username, group_id)
SELECT 'target_user', id 
FROM groups 
WHERE group_name = 'ADMIN_GROUP'
ON CONFLICT DO NOTHING;
```

#### ç»™ç”¨æˆ·ç›´æ¥æˆæƒ
```sql
-- ç»™ç”¨æˆ·ç›´æ¥æˆäºˆæƒé™
INSERT INTO authorities (username, authority) 
VALUES ('target_user', 'ROLE_ADMIN')
ON CONFLICT (username, authority) DO NOTHING;
```

#### ç§»é™¤ç”¨æˆ·æƒé™
```sql
-- ä»ç»„ä¸­ç§»é™¤ç”¨æˆ·
DELETE FROM group_members 
WHERE username = 'target_user' 
  AND group_id = (SELECT id FROM groups WHERE group_name = 'ADMIN_GROUP');

-- ç§»é™¤ç›´æ¥æƒé™
DELETE FROM authorities 
WHERE username = 'target_user' 
  AND authority = 'ROLE_ADMIN';
```

## ğŸ“Š ç»Ÿè®¡å’Œç›‘æ§æŸ¥è¯¢

### ç”¨æˆ·ç»Ÿè®¡
```sql
-- ç”¨æˆ·æ€»ä½“ç»Ÿè®¡
SELECT 
    COUNT(*) as total_users,
    COUNT(CASE WHEN enabled = true THEN 1 END) as enabled_users,
    COUNT(CASE WHEN enabled = false THEN 1 END) as disabled_users,
    COUNT(CASE WHEN first_login = true THEN 1 END) as first_login_users,
    COUNT(CASE WHEN password_change_required = true THEN 1 END) as password_change_required_users
FROM users 
WHERE username != '*';

-- æŒ‰æ ‡è¯†ç±»å‹ç»Ÿè®¡ç”¨æˆ·
SELECT 
    user_identification_type_id,
    COUNT(*) as user_count,
    COUNT(CASE WHEN verified = true THEN 1 END) as verified_count,
    COUNT(CASE WHEN verified = false THEN 1 END) as unverified_count
FROM user_identifications
GROUP BY user_identification_type_id
ORDER BY user_count DESC;
```

### æƒé™åˆ†å¸ƒç»Ÿè®¡
```sql
-- æƒé™åˆ†å¸ƒç»Ÿè®¡
SELECT 
    authority,
    COUNT(*) as user_count
FROM authorities
GROUP BY authority
ORDER BY user_count DESC;

-- ç»„æˆå‘˜ç»Ÿè®¡
SELECT 
    g.group_name,
    g.description,
    COUNT(gm.username) as member_count
FROM groups g
LEFT JOIN group_members gm ON g.id = gm.group_id
WHERE g.enabled = true
GROUP BY g.id, g.group_name, g.description
ORDER BY member_count DESC;
```

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. æ•æ„Ÿæ•°æ®ä¿æŠ¤
- æ‰‹æœºå·ã€èº«ä»½è¯å·ç­‰æ•æ„Ÿæ ‡è¯†åœ¨æŸ¥è¯¢æ—¶åº”æ³¨æ„è„±æ•
- ç”Ÿäº§ç¯å¢ƒä¸­é¿å…ç›´æ¥æŸ¥è¯¢å®Œæ•´çš„æ•æ„Ÿä¿¡æ¯

### 2. æ•°æ®ä¸€è‡´æ€§
- ä¿®æ”¹ç”¨æˆ·æƒé™æ—¶è¦æ³¨æ„äº‹åŠ¡ä¸€è‡´æ€§
- åˆ é™¤ç”¨æˆ·å‰è¦æ¸…ç†ç›¸å…³çš„æ ‡è¯†å’Œæƒé™æ•°æ®

### 3. å®¡è®¡æ—¥å¿—
- é‡è¦çš„æƒé™å˜æ›´æ“ä½œåº”è¯¥è®°å½•å®¡è®¡æ—¥å¿—
- å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨æ•°æ®åº“å®¡è®¡åŠŸèƒ½

### 4. å¤‡ä»½æ¢å¤
- åœ¨è¿›è¡Œæ‰¹é‡æƒé™æ“ä½œå‰ï¼Œå»ºè®®å…ˆå¤‡ä»½ç›¸å…³è¡¨æ•°æ®
- æµ‹è¯•ç¯å¢ƒéªŒè¯SQLåå†åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ

## ğŸ”— ç›¸å…³èµ„æº

- [é¡¹ç›®README](../README.md)
- [OAuth2å®¢æˆ·ç«¯é›†æˆæŒ‡å—](oauth2-client-integration-guide.md)
- [èµ„æºæœåŠ¡å™¨é›†æˆæŒ‡å—](resource-server-integration-guide.md)
- [æ•°æ®åº“Schema](../src/main/resources/schema.sql)
- [æµ‹è¯•æ•°æ®](../src/main/resources/data.sql)

---

**æ³¨æ„**: æœ¬æ–‡æ¡£åŸºäºå½“å‰é¡¹ç›®çš„æ•°æ®åº“ç»“æ„ç¼–å†™ï¼Œå¦‚æœ‰ç»“æ„å˜æ›´è¯·åŠæ—¶æ›´æ–°æ–‡æ¡£ã€‚