# Auth Server 数据库集成指南

## 📋 概述

本文档详细说明如何直接通过PostgreSQL数据库集成Auth Server项目，包括用户权限恢复、用户标识查询等常见场景。

## 🗄️ 数据库架构概览

### 核心表结构

#### 1. 用户表 (users)
```sql
CREATE TABLE users (
    username VARCHAR(50) NOT NULL PRIMARY KEY,  -- 用户ID（即用户名）
    password VARCHAR(100) NOT NULL,             -- 加密密码
    enabled BOOLEAN NOT NULL,                   -- 是否启用
    password_change_required BOOLEAN DEFAULT true,
    password_last_changed TIMESTAMPTZ DEFAULT NULL,
    first_login BOOLEAN DEFAULT true,
    -- 用户基本信息
    first_name VARCHAR(50) DEFAULT NULL,
    last_name VARCHAR(50) DEFAULT NULL,
    email VARCHAR(50) DEFAULT NULL,
    mobile_number VARCHAR(20) DEFAULT NULL,
    -- 其他字段...
    created_at TIMESTAMPTZ DEFAULT NULL,
    updated_at TIMESTAMPTZ DEFAULT NULL,
    referrer_id VARCHAR(255) DEFAULT NULL
);
```

#### 2. 权限表 (authorities)
```sql
CREATE TABLE authorities (
    username VARCHAR(50) NOT NULL,
    authority VARCHAR(50) NOT NULL,
    CONSTRAINT fk_authorities_users FOREIGN KEY(username) REFERENCES users(username)
);
```

#### 3. 用户组表 (groups, group_members, group_authorities)
```sql
-- 组定义
CREATE TABLE groups (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    group_name VARCHAR(50) NOT NULL UNIQUE,
    enabled BOOLEAN NOT NULL DEFAULT TRUE,
    description VARCHAR(255) DEFAULT NULL
);

-- 组成员关系
CREATE TABLE group_members (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    group_id BIGINT NOT NULL,
    CONSTRAINT fk_group_members_group FOREIGN KEY(group_id) REFERENCES groups(id)
);

-- 组权限
CREATE TABLE group_authorities (
    group_id BIGINT NOT NULL,
    authority VARCHAR(50) NOT NULL,
    CONSTRAINT fk_group_authorities_group FOREIGN KEY(group_id) REFERENCES groups(id)
);
```

#### 4. 用户标识表 (user_identifications) ⭐
```sql
CREATE TABLE user_identifications (
    user_identification_type_id VARCHAR(50) NOT NULL,  -- 标识类型
    username VARCHAR(50) NOT NULL,                     -- 用户名
    identifier VARCHAR(100) NOT NULL,                  -- 标识值
    verified BOOLEAN DEFAULT FALSE,                    -- 是否已验证
    verified_at TIMESTAMPTZ DEFAULT NULL,              -- 验证时间
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_identification_type_id, username),
    CONSTRAINT fk_user_identifications_users FOREIGN KEY(username) REFERENCES users(username)
);
```

#### 5. 权限定义表 (authority_definitions)
```sql
CREATE TABLE authority_definitions (
    authority_id VARCHAR(50) NOT NULL PRIMARY KEY,
    description VARCHAR(200),
    enabled BOOLEAN DEFAULT NULL
);
```

## 🔍 常见查询场景

### 1. 查询用户的所有标识信息

#### 查询特定用户的所有标识
```sql
-- 查询用户 'admin' 的所有标识
SELECT 
    user_identification_type_id AS 标识类型,
    identifier AS 标识值,
    verified AS 是否验证,
    verified_at AS 验证时间,
    created_at AS 创建时间
FROM user_identifications 
WHERE username = 'admin'
ORDER BY user_identification_type_id;
```

#### 查询所有用户的标识汇总
```sql
-- 查询所有用户的标识汇总（格式化显示）
SELECT 
    username AS 用户名,
    STRING_AGG(
        user_identification_type_id || ':' || identifier || 
        CASE 
            WHEN verified IS TRUE THEN '(已验证)'
            WHEN verified IS FALSE THEN '(未验证)'
            ELSE '(状态未知)'
        END, 
        ', ' ORDER BY user_identification_type_id
    ) AS 用户标识
FROM user_identifications
GROUP BY username
ORDER BY username;
```

### 2. 用户标识类型说明

当前系统支持的标识类型包括：

| 标识类型               | 说明               | 示例值                 | 来源           |
| ---------------------- | ------------------ | ---------------------- | -------------- |
| `MOBILE_NUMBER`        | 手机号（短信登录） | 13800138000            | SMS登录验证    |
| `WECHAT_OPENID`        | 微信OpenID         | oABC123def456ghi789jkl | 微信小程序登录 |
| `WECHAT_UNIONID`       | 微信UnionID        | uUNI567opq890rst123uvw | 微信开放平台   |
| `WECHAT_MOBILE_NUMBER` | 微信授权手机号     | 13700137000            | 微信授权获取   |
| `EMAIL`                | 邮箱地址           | user@example.com       | 用户注册/绑定  |
| `ID_CARD`              | 身份证号           | 11010119800101001X     | 实名认证       |

#### 按标识类型查询用户
```sql
-- 查询所有绑定了微信OpenID的用户
SELECT 
    ui.username,
    ui.identifier AS wechat_openid,
    ui.verified,
    u.enabled,
    u.first_name,
    u.last_name
FROM user_identifications ui
JOIN users u ON ui.username = u.username
WHERE ui.user_identification_type_id = 'WECHAT_OPENID'
ORDER BY ui.created_at DESC;

-- 查询所有通过手机号注册的用户
SELECT 
    ui.username,
    ui.identifier AS mobile_number,
    ui.verified,
    u.enabled,
    u.created_at
FROM user_identifications ui
JOIN users u ON ui.username = u.username
WHERE ui.user_identification_type_id = 'MOBILE_NUMBER'
ORDER BY ui.created_at DESC;
```

#### 查找重复标识
```sql
-- 查找可能的重复手机号绑定
SELECT 
    identifier AS mobile_number,
    COUNT(*) AS user_count,
    STRING_AGG(username, ', ') AS usernames
FROM user_identifications 
WHERE user_identification_type_id = 'MOBILE_NUMBER'
GROUP BY identifier
HAVING COUNT(*) > 1;
```

### 3. 用户权限查询

#### 查询用户的完整权限信息
```sql
-- 查询用户的直接权限和组权限
WITH user_direct_authorities AS (
    SELECT username, authority, 'direct' as source
    FROM authorities
    WHERE username = 'admin'
),
user_group_authorities AS (
    SELECT 
        gm.username, 
        ga.authority, 
        'group:' || g.group_name as source
    FROM group_members gm
    JOIN groups g ON gm.group_id = g.id
    JOIN group_authorities ga ON g.id = ga.group_id
    WHERE gm.username = 'admin' AND g.enabled = true
)
SELECT 
    username,
    authority,
    source
FROM user_direct_authorities
UNION ALL
SELECT 
    username,
    authority,
    source
FROM user_group_authorities
ORDER BY authority, source;
```

#### 查询用户所属的组
```sql
-- 查询用户所属的所有组
SELECT 
    u.username,
    g.group_name,
    g.description,
    g.enabled AS group_enabled
FROM users u
JOIN group_members gm ON u.username = gm.username
JOIN groups g ON gm.group_id = g.id
WHERE u.username = 'admin'
ORDER BY g.group_name;
```

### 4. 权限恢复场景

#### 从"从库"恢复用户权限
```sql
-- 假设从另一个数据库恢复权限，先查询目标用户的权限结构
-- 1. 导出用户的组成员关系
SELECT 
    gm.username,
    g.group_name,
    g.id as group_id
FROM group_members gm
JOIN groups g ON gm.group_id = g.id
WHERE gm.username IN ('user1', 'user2', 'user3')  -- 指定要恢复的用户
ORDER BY gm.username, g.group_name;

-- 2. 导出用户的直接权限
SELECT 
    username,
    authority
FROM authorities
WHERE username IN ('user1', 'user2', 'user3')  -- 指定要恢复的用户
ORDER BY username, authority;

-- 3. 导出用户的标识信息
SELECT 
    username,
    user_identification_type_id,
    identifier,
    verified,
    verified_at
FROM user_identifications
WHERE username IN ('user1', 'user2', 'user3')  -- 指定要恢复的用户
ORDER BY username, user_identification_type_id;
```

#### 批量恢复权限的SQL模板
```sql
-- 恢复组成员关系（需要先确保组存在）
INSERT INTO group_members (username, group_id)
SELECT 'target_username', id 
FROM groups 
WHERE group_name = 'TARGET_GROUP_NAME'
ON CONFLICT DO NOTHING;

-- 恢复直接权限
INSERT INTO authorities (username, authority) 
VALUES ('target_username', 'TARGET_AUTHORITY')
ON CONFLICT (username, authority) DO NOTHING;

-- 恢复用户标识
INSERT INTO user_identifications (
    user_identification_type_id, 
    username, 
    identifier, 
    verified, 
    verified_at
) VALUES (
    'MOBILE_NUMBER', 
    'target_username', 
    '13800138000', 
    true, 
    CURRENT_TIMESTAMP
) ON CONFLICT (user_identification_type_id, username) DO UPDATE SET
    identifier = EXCLUDED.identifier,
    verified = EXCLUDED.verified,
    verified_at = EXCLUDED.verified_at,
    updated_at = CURRENT_TIMESTAMP;
```

### 5. 用户排查和分析

#### 查询用户的完整信息
```sql
-- 查询用户的完整档案（包括基本信息、权限、标识）
SELECT 
    u.username,
    u.enabled,
    u.first_name,
    u.last_name,
    u.email,
    u.mobile_number,
    u.created_at,
    u.password_change_required,
    u.first_login,
    -- 组信息
    STRING_AGG(DISTINCT g.group_name, ', ') as groups,
    -- 直接权限
    STRING_AGG(DISTINCT a.authority, ', ') as direct_authorities,
    -- 标识信息
    STRING_AGG(DISTINCT 
        CASE WHEN ui.user_identification_type_id IS NOT NULL THEN
            ui.user_identification_type_id || ':' || ui.identifier || 
            CASE 
                WHEN ui.verified IS TRUE THEN '(✓)'
                WHEN ui.verified IS FALSE THEN '(✗)'
                ELSE '(?)'
            END
        END, ', ') as identifications
FROM users u
LEFT JOIN group_members gm ON u.username = gm.username
LEFT JOIN groups g ON gm.group_id = g.id AND g.enabled = true
LEFT JOIN authorities a ON u.username = a.username
LEFT JOIN user_identifications ui ON u.username = ui.username
WHERE u.username = 'admin'  -- 替换为目标用户名
GROUP BY u.username, u.enabled, u.first_name, u.last_name, u.email, 
         u.mobile_number, u.created_at, u.password_change_required, u.first_login;
```

#### 查询异常用户
```sql
-- 查询可能的异常用户
-- 1. 没有任何权限的用户
SELECT u.username, u.enabled, u.created_at
FROM users u
LEFT JOIN authorities a ON u.username = a.username
LEFT JOIN group_members gm ON u.username = gm.username
WHERE u.username != '*'  -- 排除特殊用户
  AND a.username IS NULL 
  AND gm.username IS NULL
ORDER BY u.created_at;

-- 2. 有多个相同类型标识的用户（数据异常）
SELECT 
    username,
    user_identification_type_id,
    COUNT(*) as count,
    STRING_AGG(identifier, ', ') as identifiers
FROM user_identifications
GROUP BY username, user_identification_type_id
HAVING COUNT(*) > 1;

-- 3. 标识未验证的用户
SELECT 
    ui.username,
    ui.user_identification_type_id,
    ui.identifier,
    ui.created_at,
    u.enabled
FROM user_identifications ui
JOIN users u ON ui.username = u.username
WHERE ui.verified = false
ORDER BY ui.created_at DESC;
```

## 🔧 数据维护操作

### 用户标识管理

#### 添加用户标识
```sql
-- 为用户添加手机号标识
INSERT INTO user_identifications (
    user_identification_type_id, 
    username, 
    identifier, 
    verified, 
    verified_at
) VALUES (
    'MOBILE_NUMBER', 
    'target_user', 
    '13800138000', 
    true, 
    CURRENT_TIMESTAMP
) ON CONFLICT (user_identification_type_id, username) DO UPDATE SET
    identifier = EXCLUDED.identifier,
    verified = EXCLUDED.verified,
    verified_at = EXCLUDED.verified_at,
    updated_at = CURRENT_TIMESTAMP;
```

#### 验证用户标识
```sql
-- 将用户的邮箱标识标记为已验证
UPDATE user_identifications 
SET verified = true, 
    verified_at = CURRENT_TIMESTAMP,
    updated_at = CURRENT_TIMESTAMP
WHERE username = 'target_user' 
  AND user_identification_type_id = 'EMAIL';
```

#### 删除用户标识
```sql
-- 删除用户的特定标识
DELETE FROM user_identifications 
WHERE username = 'target_user' 
  AND user_identification_type_id = 'OLD_IDENTIFICATION_TYPE';
```

### 权限管理

#### 添加用户到组
```sql
-- 将用户添加到管理员组
INSERT INTO group_members (username, group_id)
SELECT 'target_user', id 
FROM groups 
WHERE group_name = 'ADMIN_GROUP'
ON CONFLICT DO NOTHING;
```

#### 给用户直接授权
```sql
-- 给用户直接授予权限
INSERT INTO authorities (username, authority) 
VALUES ('target_user', 'ROLE_ADMIN')
ON CONFLICT (username, authority) DO NOTHING;
```

#### 移除用户权限
```sql
-- 从组中移除用户
DELETE FROM group_members 
WHERE username = 'target_user' 
  AND group_id = (SELECT id FROM groups WHERE group_name = 'ADMIN_GROUP');

-- 移除直接权限
DELETE FROM authorities 
WHERE username = 'target_user' 
  AND authority = 'ROLE_ADMIN';
```

## 📊 统计和监控查询

### 用户统计
```sql
-- 用户总体统计
SELECT 
    COUNT(*) as total_users,
    COUNT(CASE WHEN enabled = true THEN 1 END) as enabled_users,
    COUNT(CASE WHEN enabled = false THEN 1 END) as disabled_users,
    COUNT(CASE WHEN first_login = true THEN 1 END) as first_login_users,
    COUNT(CASE WHEN password_change_required = true THEN 1 END) as password_change_required_users
FROM users 
WHERE username != '*';

-- 按标识类型统计用户
SELECT 
    user_identification_type_id,
    COUNT(*) as user_count,
    COUNT(CASE WHEN verified = true THEN 1 END) as verified_count,
    COUNT(CASE WHEN verified = false THEN 1 END) as unverified_count
FROM user_identifications
GROUP BY user_identification_type_id
ORDER BY user_count DESC;
```

### 权限分布统计
```sql
-- 权限分布统计
SELECT 
    authority,
    COUNT(*) as user_count
FROM authorities
GROUP BY authority
ORDER BY user_count DESC;

-- 组成员统计
SELECT 
    g.group_name,
    g.description,
    COUNT(gm.username) as member_count
FROM groups g
LEFT JOIN group_members gm ON g.id = gm.group_id
WHERE g.enabled = true
GROUP BY g.id, g.group_name, g.description
ORDER BY member_count DESC;
```

## ⚠️ 安全注意事项

### 1. 敏感数据保护
- 手机号、身份证号等敏感标识在查询时应注意脱敏
- 生产环境中避免直接查询完整的敏感信息

### 2. 数据一致性
- 修改用户权限时要注意事务一致性
- 删除用户前要清理相关的标识和权限数据

### 3. 审计日志
- 重要的权限变更操作应该记录审计日志
- 建议在生产环境中启用数据库审计功能

### 4. 备份恢复
- 在进行批量权限操作前，建议先备份相关表数据
- 测试环境验证SQL后再在生产环境执行

## 🔗 相关资源

- [项目README](../README.md)
- [OAuth2客户端集成指南](oauth2-client-integration-guide.md)
- [资源服务器集成指南](resource-server-integration-guide.md)
- [数据库Schema](../src/main/resources/schema.sql)
- [测试数据](../src/main/resources/data.sql)

---

**注意**: 本文档基于当前项目的数据库结构编写，如有结构变更请及时更新文档。